<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live Mirror AI - V21.0 Premium</title>
    <style>
        /* M28 è¦–è¦ºå‚³æ’­ï¼šæ¥µè‡´é»‘é‡‘ç¾å­¸ */
        :root { --bg-color: #0a0a0a; --panel-bg: #141414; --accent-color: #c5a059; /* é¦™æª³é‡‘ */ --text-accent: #ff5c5c; --text-primary: #e0e0e0; }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: "Microsoft JhengHei", sans-serif; background: var(--bg-color); color: var(--text-primary); display: flex; justify-content: center; align-items: center; }
        #app-window { width: 100%; height: 100dvh; max-width: 500px; background: var(--panel-bg); display: flex; flex-direction: column; position: relative; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        header { padding: 15px; text-align: center; border-bottom: 1px solid #333; font-weight: bold; flex: none; font-size: 18px; display: flex; justify-content: center; align-items: center; gap: 10px; color: var(--accent-color); letter-spacing: 1px; }
        .version-tag { font-size: 10px; background: linear-gradient(45deg, #d4af37, #f0e68c); padding: 2px 8px; border-radius: 4px; color: #000; font-weight: 900; }

        .stage { flex: 1; display: none; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        .active { display: flex; animation: fadeIn 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .viewport { width: 100%; min-height: 300px; background: #000; border: none; overflow: hidden; position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; flex: none; }
        video, img { width: 100%; height: 100%; object-fit: contain; max-height: 60vh; } 
        .mirror { transform: scaleX(-1); }

        .control-panel { width: 100%; background: #1f1f1f; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .panel-title { font-size: 14px; color: var(--accent-color); margin-bottom: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; text-transform: uppercase; letter-spacing: 1px; }
        
        .ai-only-section { display: block; }
        .upload-mode .ai-only-section { display: none !important; }

        .detail-textarea { width: 100%; padding: 10px; background: #2b2b2b; color: white; border: 1px solid #444; border-radius: 6px; font-size: 14px; outline: none; margin-bottom: 10px; resize: none; font-family: inherit; }
        .detail-input { width: 100%; padding: 10px; background: #2b2b2b; color: white; border: 1px solid #444; border-radius: 6px; font-size: 14px; outline: none; margin-bottom: 10px; }
        .detail-input:focus, .detail-textarea:focus { border-color: var(--accent-color); background: #333; }

        .select-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .select-group { display: flex; flex-direction: column; gap: 5px; }
        .select-label { font-size: 11px; color: #888; margin-left: 2px; }
        select.detail-select { width: 100%; padding: 8px; background: #2b2b2b; color: white; border: 1px solid #444; border-radius: 6px; font-size: 13px; outline: none; appearance: none; transition: border 0.3s; }
        select.detail-select:focus { border-color: var(--accent-color); }

        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--accent-color); cursor: pointer; margin-top: -6px; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #444; border-radius: 2px; }

        #start-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; backdrop-filter: blur(5px); }
        
        .btn-group { display: flex; gap: 15px; width: 100%; justify-content: center; margin-top: 20px; }
        .btn-action { flex: 1; padding: 14px 0; border-radius: 50px; border: none; background: linear-gradient(135deg, #d4af37, #aa8a2e); color: #000; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4); max-width: 180px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: transform 0.1s; }
        .btn-action:active { transform: scale(0.95); }
        .btn-upload { background: linear-gradient(135deg, #444, #222); color: white; border: 1px solid #555; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .btn-upload:hover { background: #555; }

        select.camera-select { width: 100%; padding: 12px; margin-bottom: 15px; background: #333; color: white; border: 1px solid #555; border-radius: 12px; font-size: 16px; outline: none; }
        
        .style-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; padding-bottom: 40px;}
        .style-card { background: #252525; border: 1px solid #444; border-radius: 8px; padding: 12px 5px; cursor: pointer; text-align: center; font-size: 14px; position: relative; overflow: hidden; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .style-card:active { transform: scale(0.96); background: #333; }
        .style-real { border: 1px solid var(--accent-color); background: rgba(212, 175, 55, 0.1); }
        .style-tao { border: 1px solid #fff; background: linear-gradient(45deg, #2a2a2a, #555); }

        .gender-toggle { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .gender-option { flex: 1; text-align: center; padding: 10px; background: #252525; border-radius: 8px; border: 1px solid #444; cursor: pointer; font-weight: bold; color: #888; font-size: 15px; transition: all 0.3s; }
        .gender-option.selected { background: var(--accent-color); color: #000; border-color: var(--accent-color); box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }
        
        canvas { display: none !important; }
        #file-input { display: none; }
    </style>
</head>
<body>

<div id="app-window">
    <header>
        Live Mirror AI <span class="version-tag">V21.0 Premium</span>
    </header>

    <div id="start-overlay">
        <h1 style="color:white; margin-bottom:10px;">ğŸ‘‹ æ­¡è¿é«”é©—</h1>
        <p style="color:#aaa; margin-bottom:20px;">V21.0 é ‚ç´šå·¥è—ç‰ˆ</p>
        
        <div id="btn-container" class="btn-group">
            <button class="btn-action" onclick="initCameraMode()">ğŸ“¸ å•Ÿå‹•ç›¸æ©Ÿ<br>(AI ç”Ÿæˆ)</button>
            <button class="btn-action btn-upload" onclick="triggerUpload()">ğŸ“ ä¸Šå‚³ç…§ç‰‡<br>(ç´”è£è£±)</button>
        </div>

        <div id="step-selection" style="display:none; width:100%; margin-top: 20px;">
            <p style="color:white; margin-bottom:15px;">è«‹é¸æ“‡é¡é ­ï¼š</p>
            <select id="camera-list" class="camera-select"></select>
            <div style="display:flex; justify-content:center;"><button class="btn-action" onclick="confirmCamera()">âœ… ç¢ºèª</button></div>
        </div>
        <p id="error-msg" style="color: #ff5c5c; font-size: 12px; margin-top: 20px; max-width: 80%;"></p>
    </div>
    
    <input type="file" id="file-input" accept="image/*">

    <div id="stage-1" class="stage">
        <div class="viewport" style="aspect-ratio: 3/4;">
            <video id="webcam" playsinline class="mirror" autoplay></video>
        </div>
        <button class="btn-action" onclick="capturePhoto()">ğŸ“¸ æ‹ç…§</button>
        <p style="margin-top:20px; font-size:14px; color:#666; cursor:pointer; text-decoration: underline;" onclick="location.reload()">[è¿”å›é¦–é ]</p>
    </div>

    <div id="stage-2" class="stage">
        <div class="viewport" style="width: 160px; height: 160px; min-height: auto; border-radius: 12px; border: 2px solid var(--accent-color); margin-top: 5px;">
            <img id="preview-img" src="">
        </div>
        
        <div class="ai-only-section">
            <div class="gender-toggle">
                <div class="gender-option" onclick="switchGender('boy')" id="btn-boy">ğŸ‘¦ ç”·ç”Ÿ</div>
                <div class="gender-option selected" onclick="switchGender('girl')" id="btn-girl">ğŸ‘§ å¥³ç”Ÿ</div>
            </div>

            <div class="control-panel">
                <div class="panel-title">ğŸ¬ å°æ¼”æŒ‡ä»¤ (AIè¨­å®š)</div>
                <div class="select-grid">
                    <div class="select-group"><span class="select-label">ğŸ‘— æœè£</span><select id="opt-clothes" class="detail-select"></select></div>
                    <div class="select-group"><span class="select-label">ğŸ’‡ é«®å‹</span><select id="opt-hair" class="detail-select"></select></div>
                    <div class="select-group"><span class="select-label">ğŸ‘‘ é ­é£¾</span><select id="opt-headwear" class="detail-select"></select></div>
                    <div class="select-group"><span class="select-label">ğŸ¤² æ‰‹æŒç‰©å“</span><select id="opt-held" class="detail-select"></select></div>
                    <div class="select-group"><span class="select-label">ğŸ“ åœ°é»</span><select id="opt-location" class="detail-select">
                        <option value="">(éš¨æ©Ÿ)</option><option value="in a forest">æ£®æ—</option><option value="at the beach">æµ·é‚Š</option><option value="in a cyberpunk city">æœªä¾†åŸå¸‚</option><option value="in an ancient temple">å¤è€å»Ÿå®‡</option><option value="in a classroom">æ•™å®¤</option><option value="in outer space">å¤–å¤ªç©º</option><option value="in a library">åœ–æ›¸é¤¨</option><option value="in a flower field">æµªæ¼«èŠ±æµ·</option><option value="on a snowy mountain">é›ªå±±ä¹‹å·”</option><option value="on a concert stage">æ¼”å”±æœƒèˆå°</option>
                    </select></div>
                    <div class="select-group"><span class="select-label">ğŸŒ¤ï¸ å¤©æ°£/æ°›åœ</span><select id="opt-weather" class="detail-select">
                        <option value="">(éš¨æ©Ÿ)</option><option value="sunny day, bright lighting">é™½å…‰ç‡¦çˆ›</option><option value="raining, cinematic lighting">ä¸‹é›¨é›»å½±æ„Ÿ</option><option value="starry night">æ˜Ÿç©ºå¤œæ™š</option><option value="sunset, golden hour">é»ƒæ˜é‡‘å…‰</option><option value="foggy, mysterious">éœ§æ°£ç¥ç§˜</option><option value="cherry blossoms falling">æ«»èŠ±é›¨</option><option value="northern lights sky">æ¥µå…‰</option><option value="rainbow in sky">å½©è™¹</option><option value="thunderstorm background">é›·é›»äº¤åŠ </option>
                    </select></div>
                </div>
            </div>
        </div>

        <div class="control-panel" style="border-color: #666;">
            <div class="panel-title" style="color: #fff;">âœï¸ åœ–æ–‡èˆ‡è£è£±</div>
            <div style="display: flex; flex-direction: column;">
                <textarea id="text-main" rows="2" placeholder="è¼¸å…¥ä½ æƒ³å¯«çš„è©±..." class="detail-textarea"></textarea>
                
                <div class="select-group" style="margin-bottom: 10px;">
                    <span class="select-label">ğŸ”  æ–‡å­—å¤§å°</span>
                    <input type="range" id="text-size" min="10" max="100" value="30">
                </div>

                <div class="select-grid">
                    <div class="select-group"><span class="select-label">ğŸ…°ï¸ æ–‡å­—é¢¨æ ¼</span><select id="text-style" class="detail-select"><option value="none">(ä¸åŠ æ–‡å­—)</option><option value="calligraphy">1. å¤å…¸æ›¸æ³•</option><option value="neon">2. è³½åšéœ“è™¹</option><option value="comic">3. ç†±è¡€æ¼«ç•«</option><option value="cute">4. å¯æ„›æ‰‹å¯«</option><option value="elegant">5. å„ªé›…é‡‘æ¼†</option><option value="typewriter">6. å¾©å¤æ‰“å­—æ©Ÿ</option><option value="graffiti">7. è¡—é ­å¡—é´‰</option><option value="headline">8. æ–°èæ¨™é¡Œ</option><option value="stone">9. æµ®é›•çŸ³åˆ»</option><option value="ink">10. æ°´å¢¨æšˆæŸ“</option></select></div>
                    <div class="select-group"><span class="select-label">â†•ï¸ æ–‡å­—ä½ç½®</span><select id="text-position" class="detail-select"><option value="bottom">ç½®åº• (é è¨­)</option><option value="top">ç½®é ‚</option><option value="center">æ­£ä¸­é–“</option></select></div>
                </div>

                <div style="border-top: 1px solid #444; padding-top: 10px; margin-top: 10px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 20px; margin-right: 5px;">ğŸˆ´</span>
                        <input type="text" id="text-signature" placeholder="è½æ¬¾å¤§å" class="detail-input" style="margin-bottom: 0; border-color: #ff5c5c;">
                    </div>
                    <div class="select-grid">
                        <div class="select-group"><span class="select-label">ğŸ”´ å°ç« å½¢ç‹€</span><select id="seal-shape" class="detail-select"><option value="square">1. æ­£æ–¹å°</option><option value="rect">2. é•·æ–¹å°</option><option value="circle">3. åœ“å½¢å°</option><option value="oval">4. æ©¢åœ“å°</option><option value="rounded">5. åœ“è§’å°</option></select></div>
                        <div class="select-group"><span class="select-label">âœ’ï¸ å°ç« å­—é«”</span><select id="seal-font" class="detail-select"><option value="standard">1. æ¨™æº–æ­£æ¥·</option><option value="serif_bold">2. èŠé‡å®‹é«”</option><option value="cursive">3. é£„é€¸è¡Œæ›¸</option><option value="heavy">4. åšé‡é»‘é«”</option><option value="thin">5. æ¸…ç§€ç´°æ˜</option><option value="old">6. ä»¿å¤éš¸æ›¸</option><option value="seal_script">7. æ¨¡æ“¬ç¯†åˆ»</option><option value="rough">8. æ–‘é§å¤å°</option><option value="ink_bleed">9. å¢¨æšˆæ‰‹å¯«</option><option value="modern">10. ç¾ä»£è¨­è¨ˆ</option></select></div>
                    </div>
                </div>

                <div class="select-group" style="margin-top: 10px; border-top: 1px solid #444; padding-top: 10px;">
                    <span class="select-label">ğŸ–¼ï¸ V21 é ‚ç´šé‚Šæ¡†</span>
                    <select id="frame-style" class="detail-select" style="border-color: var(--accent-color); font-weight: bold;">
                        <option value="none">(ä¸åŠ é‚Šæ¡†)</option>
                        <option value="gold_classic">1. ğŸ‘‘ ç¶“å…¸é‡‘ç®”æ¡† (3D)</option>
                        <option value="silver_antique">2. ğŸ›ï¸ å¤å…¸éŠ€é›•æ¡†</option>
                        <option value="wood_walnut">3. ğŸªµ æ·±èƒ¡æ¡ƒæœ¨ (ç´‹ç†)</option>
                        <option value="wood_oak">4. ğŸŒ¿ æ·ºè‰²æ©¡æœ¨</option>
                        <option value="museum_mat">5. ğŸ–¼ï¸ åšç‰©é¤¨è¥¯ç´™ (åˆ‡è§’)</option>
                        <option value="gallery_black">6. â¬› æ¥µç°¡é»‘è—å»Š</option>
                        <option value="ornate_vintage">7. âšœï¸ æ­å¼ç¹è¤‡ (å¤šå±¤)</option>
                        <option value="modern_metal">8. âš™ï¸ å·¥æ¥­é¢¨é‡‘å±¬</option>
                        <option value="rustic">9. ğŸ‚ é„‰æ‘é¢¨èˆŠæœ¨</option>
                        <option value="neon_cyber">10. ğŸ† è³½åšéœ“è™¹æ¡†</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="ai-only-section">
            <h3 style="width:100%; font-size:14px; color:#888; margin-bottom:10px;">ç¢ºèª AI ç•«é¢¨ï¼š</h3>
            <div class="style-grid">
                <div class="style-card style-real" onclick="generateAI('real')">ğŸ“¸ çœŸäººæ“¬çœŸ</div>
                <div class="style-card style-tao" onclick="generateAI('taoist')">ğŸ•Šï¸ ç™½é™½è–æ½”</div>
                <div class="style-card" onclick="generateAI('pixar')">ğŸ§¸ çš®å…‹æ–¯é¢¨</div>
                <div class="style-card" onclick="generateAI('ghibli')">ğŸƒ å‰åœåŠ›é¢¨</div>
                <div class="style-card" onclick="generateAI('cyberpunk')">ğŸŒƒ è³½åšé¾å…‹</div>
                <div class="style-card" onclick="generateAI('oil')">ğŸ¨ æ¢µè°·æ²¹ç•«</div>
                <div class="style-card" onclick="generateAI('comic')">ğŸ’¥ ç¾å¼æ¼«ç•«</div>
                <div class="style-card" onclick="generateAI('ink')">ğŸ–Œï¸ æ±æ–¹æ°´å¢¨</div>
            </div>
        </div>

        <button id="btn-upload-finish" class="btn-action" onclick="finishUploadMode()" style="display:none; width:100%; max-width:none; margin-bottom: 20px;">âœ¨ ç¢ºèªè£è£± (è·³éAI)</button>
        <button style="margin-top:5px; background:transparent; border:none; color:#666; font-size:15px;" onclick="location.reload()">â¬…ï¸ è¿”å›é¦–é </button>
    </div>

    <div id="stage-3" class="stage" style="justify-content: center;">
        <h2 id="loading-text">âš¡ è™•ç†ä¸­...</h2>
        <div style="width:70%; height:6px; background:#333; margin-top:20px; border-radius:3px;">
            <div id="progress-bar" style="width:0%; height:100%; background:var(--accent-color); transition:width 0.3s;"></div>
        </div>
        <p id="prompt-debug" style="color:#666; font-size:12px; margin-top:15px; max-width:80%; text-align:center;"></p>
    </div>

    <div id="stage-4" class="stage">
        <h2>âœ¨ æ‚¨çš„å…¸è—å¤§ä½œ</h2>
        <div class="viewport" style="background: transparent; box-shadow: none; border: none;">
            <img id="final-result" src="">
        </div>
        <p style="color: var(--accent-color); font-weight: bold; font-size: 18px; margin-top: 5px;">ğŸ‘‡ é•·æŒ‰åœ–ç‰‡å„²å­˜ ğŸ‘‡</p>
        <div style="font-size: 13px; color: #888; margin-top: 20px; border-top: 1px solid #333; padding-top: 15px; width: 100%; text-align: center;">
            åˆ†äº«é€£çµï¼š
            <div id="qrcode-container" style="margin-top: 10px; background: white; padding: 10px; display: inline-block; border-radius: 12px;"></div>
        </div>
        <button class="btn-action" onclick="location.reload()" style="background:#333; color:white; font-size:16px; margin-top: 20px; max-width:none;">ğŸ”„ å†ç©ä¸€æ¬¡</button>
    </div>

    <canvas id="canvas-comp"></canvas>
    <canvas id="canvas-resize"></canvas>
    <canvas id="canvas"></canvas>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    const video = document.getElementById('webcam'), canvas = document.getElementById('canvas'), previewImg = document.getElementById('preview-img'), finalImg = document.getElementById('final-result'), cameraList = document.getElementById('camera-list'), errorMsg = document.getElementById('error-msg');
    const canvasComp = document.getElementById('canvas-comp');
    const canvasResize = document.getElementById('canvas-resize');
    let currentGender = 'girl'; 
    let isUploadMode = false; 

    async function initCameraMode() {
        errorMsg.innerText = "";
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            await listCameras();
            stream.getTracks().forEach(track => track.stop());
            setMode(false);
            const btnContainer = document.getElementById('btn-container');
            if(btnContainer) btnContainer.style.display = 'none';
            document.getElementById('step-selection').style.display = 'block';
        } catch (err) {
            console.error(err);
            errorMsg.innerText = "å•Ÿå‹•å¤±æ•—ï¼šè«‹ç¢ºèªç€è¦½å™¨å·²å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚";
        }
    }

    async function listCameras() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        cameraList.innerHTML = '';
        videoDevices.forEach((device, index) => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            let label = device.label || `ç›¸æ©Ÿ ${index + 1}`;
            if (label.toLowerCase().includes('back') || label.includes('å¾Œ')) label = "ğŸ“¸ å¾Œç½®é¡é ­";
            else if (label.toLowerCase().includes('front') || label.includes('å‰')) label = "ğŸ‘¤ å‰ç½®è‡ªæ‹";
            option.text = label;
            cameraList.appendChild(option);
        });
    }

    async function confirmCamera() {
        const deviceId = cameraList.value;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } });
            video.srcObject = stream;
            document.getElementById('start-overlay').style.display = 'none';
            switchStage('stage-1');
        } catch (err) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                document.getElementById('start-overlay').style.display = 'none';
                switchStage('stage-1');
            } catch (fatalErr) { alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—"); }
        }
    }

    const optionsData = {
        girl: { clothes: [{val:"", txt:"(é è¨­)"}, {val:"wearing white hanfu", txt:"æ¼¢æœ/å¤è£"}, {val:"wearing princess dress", txt:"å¤¢å¹»å…¬ä¸»è£™"}, {val:"wearing qipao dress", txt:"æ——è¢"}, {val:"wearing school uniform", txt:"æ°´æ‰‹æœ/åˆ¶æœ"}, {val:"wearing business suit", txt:"è¥¿è£/å¥—è£"}, {val:"wearing casual t-shirt", txt:"ä¼‘é–’ Tæ¤"}, {val:"wearing cyberpunk armor", txt:"ç§‘æŠ€æˆ°ç”²"}, {val:"wearing witch robe", txt:"å¥³å·«è¢"}, {val:"wearing yoga outfit", txt:"ç‘œçˆæœ"}], hair: [{val:"", txt:"(é è¨­)"}, {val:"long curly hair", txt:"é•·æ²é«®"}, {val:"short bob hair", txt:"ä¿éº—çŸ­é«®"}, {val:"ponytail", txt:"é¦¬å°¾"}, {val:"straight long hair", txt:"é»‘é•·ç›´"}, {val:"twin tails", txt:"é›™é¦¬å°¾"}, {val:"braided hair", txt:"éº»èŠ±è¾®"}, {val:"hair bun", txt:"åŒ…åŒ…é ­"}, {val:"hime cut", txt:"å…¬ä¸»åˆ‡"}], headwear: [{val:"", txt:"(ç„¡)"}, {val:"wearing glasses", txt:"çœ¼é¡"}, {val:"wearing a flower hairpin", txt:"èŠ±æœµé«®ç°ª"}, {val:"wearing a crown", txt:"çš‡å† "}, {val:"wearing cat ears", txt:"è²“è€³"}, {val:"wearing a beret", txt:"ç•«å®¶å¸½"}, {val:"wearing a veil", txt:"é ­ç´—"}, {val:"wearing headphones", txt:"è€³æ©Ÿ"}, {val:"wearing a halo", txt:"å¤©ä½¿å…‰ç’°"}], held: [{val:"", txt:"(ç„¡)"}, {val:"holding a book", txt:"æ‹¿è‘—æ›¸"}, {val:"holding a lotus flower", txt:"æ‹¿è‘—è“®èŠ±"}, {val:"holding a magic wand", txt:"é­”æ³•æ£’"}, {val:"holding bubble tea", txt:"çç å¥¶èŒ¶"}, {val:"holding a camera", txt:"æ‹¿è‘—ç›¸æ©Ÿ"}, {val:"holding a fan", txt:"æ‹¿è‘—æ‰‡å­"}, {val:"holding a guitar", txt:"æŠ±è‘—å‰ä»–"}, {val:"holding a bouquet", txt:"æ§è‘—èŠ±æŸ"}] },
        boy: { clothes: [{val:"", txt:"(é è¨­)"}, {val:"wearing white hanfu", txt:"æ¼¢æœ/å¤è£"}, {val:"wearing business suit", txt:"è¥¿è£/æ­£è£"}, {val:"wearing doctor coat", txt:"é†«å¸«è¢"}, {val:"wearing leather jacket", txt:"å¸¥æ°£çš®è¡£"}, {val:"wearing basketball jersey", txt:"ç±ƒçƒè¡£"}, {val:"wearing casual hoodie", txt:"é€£å¸½è¡«"}, {val:"wearing cyberpunk armor", txt:"ç§‘æŠ€æˆ°ç”²"}, {val:"wearing tactical vest", txt:"æˆ°è¡“èƒŒå¿ƒ"}, {val:"wearing tuxedo", txt:"ç‡•å°¾æœ"}], hair: [{val:"", txt:"(é è¨­)"}, {val:"short hair", txt:"ä¿è½çŸ­é«®"}, {val:"middle part hair", txt:"éŸ“ç³»ä¸­åˆ†"}, {val:"slicked back hair", txt:"æ²¹é ­"}, {val:"buzz cut", txt:"å¹³é ­/å…‰é ­"}, {val:"spikey hair", txt:"åˆºèŸé ­"}, {val:"long hair", txt:"è—è¡“é•·é«®"}, {val:"dreadlocks", txt:"é›·é¬¼é«’è¾®"}, {val:"undercut", txt:"å…©å´æ¨é«˜"}], headwear: [{val:"", txt:"(ç„¡)"}, {val:"wearing glasses", txt:"çœ¼é¡"}, {val:"wearing a baseball cap", txt:"æ£’çƒå¸½"}, {val:"wearing a fedora", txt:"ç´³å£«å¸½"}, {val:"wearing a bandana", txt:"é ­å·¾"}, {val:"wearing headphones", txt:"è€³æ©Ÿ"}, {val:"wearing vr goggles", txt:"VRçœ¼é¡"}, {val:"wearing a halo", txt:"å¤©ä½¿å…‰ç’°"}, {val:"wearing a crown", txt:"åœ‹ç‹çš‡å† "}], held: [{val:"", txt:"(ç„¡)"}, {val:"holding a book", txt:"æ‹¿è‘—æ›¸"}, {val:"holding a sword", txt:"æ‹¿è‘—åŠ"}, {val:"holding a guitar", txt:"æŠ±è‘—å‰ä»–"}, {val:"holding a camera", txt:"æ‹¿è‘—ç›¸æ©Ÿ"}, {val:"holding a basketball", txt:"æ‹¿è‘—ç±ƒçƒ"}, {val:"holding a coffee cup", txt:"æ‹¿è‘—å’–å•¡"}, {val:"holding a laptop", txt:"æ‹¿è‘—ç­†é›»"}, {val:"holding a microphone", txt:"æ‹¿è‘—éº¥å…‹é¢¨"}] }
    };

    function updateOptions(gender) { const data = optionsData[gender]; const populate = (id, items) => { const select = document.getElementById(id); select.innerHTML = ""; items.forEach(item => { const opt = document.createElement("option"); opt.value = item.val; opt.innerText = item.txt; select.appendChild(opt); }); }; populate('opt-clothes', data.clothes); populate('opt-hair', data.hair); populate('opt-headwear', data.headwear); populate('opt-held', data.held); }
    function switchGender(g) { currentGender = g; document.getElementById('btn-boy').classList.toggle('selected', g==='boy'); document.getElementById('btn-girl').classList.toggle('selected', g==='girl'); updateOptions(g); }
    window.onload = () => { updateOptions('girl'); };

    function setMode(upload) { isUploadMode = upload; const stage2 = document.getElementById('stage-2'); const uploadBtn = document.getElementById('btn-upload-finish'); if (isUploadMode) { stage2.classList.add('upload-mode'); uploadBtn.style.display = 'flex'; previewImg.classList.remove('mirror'); } else { stage2.classList.remove('upload-mode'); uploadBtn.style.display = 'none'; previewImg.classList.add('mirror'); } }
    function triggerUpload() { document.getElementById('file-input').click(); }
    document.getElementById('file-input').addEventListener('change', function(e) { if (e.target.files && e.target.files[0]) { const reader = new FileReader(); reader.onload = function(event) { const img = new Image(); img.onload = function() { const MAX_SIZE = 1024; let w = img.width; let h = img.height; if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } } else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } } canvasResize.width = w; canvasResize.height = h; const ctx = canvasResize.getContext('2d'); ctx.drawImage(img, 0, 0, w, h); previewImg.src = canvasResize.toDataURL('image/jpeg', 0.9); setMode(true); document.getElementById('start-overlay').style.display = 'none'; switchStage('stage-2'); }; img.src = event.target.result; }; reader.readAsDataURL(e.target.files[0]); } });
    function finishUploadMode() { composeFinalImage(previewImg.src, "ç…§ç‰‡è£è£±ä¸­..."); }
    function capturePhoto() { canvas.width = video.videoWidth; canvas.height = video.videoHeight; const ctx = canvas.getContext('2d'); ctx.translate(canvas.width, 0); ctx.scale(-1, 1); ctx.drawImage(video, 0, 0, canvas.width, canvas.height); previewImg.src = canvas.toDataURL('image/png'); setMode(false); switchStage('stage-2'); }

    function composeFinalImage(sourceImageUrl, loadingMsg) {
        switchStage('stage-3'); 
        document.getElementById('loading-text').innerText = loadingMsg || "âš¡ è™•ç†ä¸­...";
        document.getElementById('prompt-debug').innerText = ""; 
        simulateProgress();

        const rawText = document.getElementById('text-main').value;
        const textStyle = document.getElementById('text-style').value;
        const signature = document.getElementById('text-signature').value;
        const position = document.getElementById('text-position').value;
        const frameStyle = document.getElementById('frame-style').value;
        const textSizeVal = document.getElementById('text-size').value; 
        const sealShape = document.getElementById('seal-shape').value; 
        const sealFont = document.getElementById('seal-font').value; 

        const baseImg = new Image();
        baseImg.crossOrigin = "anonymous"; 
        baseImg.onload = () => {
            let frameThickness = 0; let matThickness = 0;
            let totalBorder = 0;
            if (frameStyle !== 'none') {
                // V21: æ ¹æ“šç•«æ¡†é¢¨æ ¼è¨­å®šæ›´çœŸå¯¦çš„åšåº¦æ¯”ä¾‹
                if(frameStyle.includes('gold') || frameStyle.includes('vintage')) frameThickness = baseImg.width * 0.08;
                else frameThickness = baseImg.width * 0.05;
                
                if (frameStyle === 'museum_mat') matThickness = baseImg.width * 0.12; // åšç‰©é¤¨ç´šéœ€è¦å¾ˆå¯¬çš„è¥¯ç´™
                else if (frameStyle !== 'none') matThickness = 0; 
                
                // éƒ¨åˆ†ç•«æ¡†æœ‰å…§è¥¯
                if(frameStyle === 'gold_classic' || frameStyle === 'silver_antique') matThickness = baseImg.width * 0.02;
            }
            totalBorder = Math.floor(frameThickness + matThickness);

            canvasComp.width = baseImg.width + (totalBorder * 2);
            canvasComp.height = baseImg.height + (totalBorder * 2);
            const ctx = canvasComp.getContext('2d');
            const cw = canvasComp.width; const ch = canvasComp.height;

            if (frameStyle !== 'none') { applyFrameDrawing(ctx, frameStyle, cw, ch, Math.floor(frameThickness), Math.floor(matThickness)); }

            const contentX = totalBorder; const contentY = totalBorder;
            const contentW = baseImg.width; const contentH = baseImg.height;

            ctx.drawImage(baseImg, contentX, contentY);

            ctx.save(); ctx.beginPath(); ctx.rect(contentX, contentY, contentW, contentH); ctx.clip();

            if (rawText && textStyle !== 'none') {
                const lines = rawText.split('\n');
                const fontSize = Math.floor(contentW * (textSizeVal / 500)); 
                applyTextStyle(ctx, textStyle, fontSize);
                ctx.textAlign = 'center';
                const lineHeight = fontSize * 1.3;
                let startY;
                if (position === 'top') startY = contentY + fontSize * 2;
                else if (position === 'center') startY = contentY + (contentH / 2) - ((lines.length * lineHeight) / 2);
                else startY = contentY + contentH - (lines.length * lineHeight) - fontSize;

                lines.forEach((line, i) => {
                    let y = startY + (i * lineHeight);
                    ctx.fillText(line, contentX + contentW / 2, y);
                    if (['comic', 'neon', 'stone'].includes(textStyle)) { ctx.strokeText(line, contentX + contentW / 2, y); }
                });
            }
            if (signature) { drawRealSeal(ctx, signature, sealShape, sealFont, contentX + contentW, contentY + contentH); }
            ctx.restore();

            if (frameStyle !== 'none' && frameStyle !== 'neon_cyber') { drawInnerShadow(ctx, contentX, contentY, contentW, contentH); }

            finalImg.src = canvasComp.toDataURL('image/png');
            document.getElementById("qrcode-container").innerHTML = ""; 
            new QRCode(document.getElementById("qrcode-container"), { text: window.location.href, width: 120, height: 120 }); 
            switchStage('stage-4');
        };
        baseImg.onerror = () => { alert("åœ–ç‰‡è¼‰å…¥å¤±æ•—"); location.reload(); };
        baseImg.src = sourceImageUrl;
    }

    // V21: é ‚ç´šå·¥è—é‚Šæ¡†ç¹ªè£½ (Procedural textures & bevels)
    function applyFrameDrawing(ctx, style, w, h, ft, mt) {
        const total = ft + mt;
        // 1. èƒŒæ™¯å±¤ (å¦‚æœæœ‰è¥¯ç´™)
        if (mt > 0) {
            // åšç‰©é¤¨ç´™ç´‹ç†
            ctx.fillStyle = '#fdfdfd'; 
            ctx.fillRect(0, 0, w, h);
            // åŠ å…¥å™ªé»ç´‹ç†
            drawNoise(ctx, 0, 0, w, h, 0.03);
            
            // è¥¯ç´™å…§åˆ‡è§’ (Bevel Cut)
            ctx.fillStyle = '#e0e0e0'; // é™°å½±
            ctx.fillRect(ft, ft, w - ft*2, h - ft*2);
            ctx.fillStyle = '#fff'; // äº®é¢
            ctx.fillRect(ft+2, ft+2, w - ft*2 - 4, h - ft*2 - 4);
        }

        // 2. å¤–æ¡†å±¤
        if (ft > 0) {
            // å®šç¾©å¤–æ¡†å€åŸŸ
            ctx.beginPath(); ctx.rect(0, 0, w, h); ctx.rect(total, total, w - total*2, h - total*2); 
            ctx.fillStyle = '#000'; ctx.fill('evenodd'); // æ¸…ç©ºå€åŸŸ

            // æ ¹æ“šé¢¨æ ¼ç¹ªè£½æè³ª
            ctx.save();
            ctx.beginPath(); ctx.rect(0, 0, w, h); ctx.rect(total, total, w - total*2, h - total*2); ctx.clip('evenodd');

            if (style === 'gold_classic') {
                // é‡‘ç®”è³ªæ„Ÿ
                let grad = ctx.createLinearGradient(0, 0, w, h);
                grad.addColorStop(0, '#bf953f'); grad.addColorStop(0.25, '#fcf6ba'); grad.addColorStop(0.5, '#b38728'); grad.addColorStop(0.75, '#fbf5b7'); grad.addColorStop(1, '#aa771c');
                ctx.fillStyle = grad; ctx.fillRect(0,0,w,h);
                drawNoise(ctx, 0,0,w,h, 0.05); // é‡‘å±¬é¡†ç²’
                drawBevel(ctx, 0, 0, w, h, ft, 'rgba(255,255,255,0.6)', 'rgba(60,40,0,0.6)'); // å¤–æ–œè§’
            } 
            else if (style === 'wood_walnut') {
                // æ·±èƒ¡æ¡ƒæœ¨
                ctx.fillStyle = '#3e2723'; ctx.fillRect(0,0,w,h);
                drawWoodGrain(ctx, w, h, '#281815', 0.3);
                drawBevel(ctx, 0, 0, w, h, ft, 'rgba(255,255,255,0.1)', 'rgba(0,0,0,0.6)');
            }
            else if (style === 'wood_oak') {
                // æ·ºæ©¡æœ¨
                ctx.fillStyle = '#d7c49e'; ctx.fillRect(0,0,w,h);
                drawWoodGrain(ctx, w, h, '#bfa37a', 0.2);
                drawBevel(ctx, 0, 0, w, h, ft, 'rgba(255,255,255,0.3)', 'rgba(100,80,50,0.4)');
            }
            else if (style === 'ornate_vintage') {
                // ç¹è¤‡æ¡† (å¤šå±¤)
                let grad = ctx.createLinearGradient(0, 0, w, 0);
                grad.addColorStop(0, '#222'); grad.addColorStop(0.5, '#444'); grad.addColorStop(1, '#222');
                ctx.fillStyle = grad; ctx.fillRect(0,0,w,h);
                // å…§é‡‘ç·š
                ctx.strokeStyle = '#d4af37'; ctx.lineWidth = ft * 0.2;
                ctx.strokeRect(ft/2, ft/2, w-ft, h-ft);
                drawBevel(ctx, 0, 0, w, h, ft, 'rgba(255,255,255,0.2)', 'rgba(0,0,0,0.8)');
            }
            else if (style === 'neon_cyber') {
                ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
                ctx.shadowColor = '#00eaff'; ctx.shadowBlur = 30; 
                ctx.strokeStyle = '#ff00de'; ctx.lineWidth = 4;
                ctx.strokeRect(ft, ft, w - ft*2, h - ft*2); // å…§ç™¼å…‰
                ctx.shadowBlur = 0;
            }
            else if (style === 'gallery_black') {
                ctx.fillStyle = '#111'; ctx.fillRect(0,0,w,h);
                drawBevel(ctx, 0, 0, w, h, ft, 'rgba(255,255,255,0.15)', 'rgba(0,0,0,0.8)'); // æ¥µç°¡å…‰å½±
            }
            else {
                // é è¨­/å…¶ä»–
                ctx.fillStyle = '#333'; ctx.fillRect(0,0,w,h);
                drawBevel(ctx, 0, 0, w, h, ft, 'rgba(255,255,255,0.2)', 'rgba(0,0,0,0.5)');
            }
            ctx.restore();
        }
    }

    // V21 è¼”åŠ©ï¼šç¹ªè£½æ–œè§’ç«‹é«”æ„Ÿ (Trapazoid bevels)
    function drawBevel(ctx, x, y, w, h, thick, lightColor, shadowColor) {
        // Top
        ctx.fillStyle = lightColor;
        ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+w,y); ctx.lineTo(x+w-thick, y+thick); ctx.lineTo(x+thick, y+thick); ctx.fill();
        // Left
        ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+thick,y+thick); ctx.lineTo(x+thick, y+h-thick); ctx.lineTo(x, y+h); ctx.fill();
        // Right
        ctx.fillStyle = shadowColor;
        ctx.beginPath(); ctx.moveTo(x+w,y); ctx.lineTo(x+w,y+h); ctx.lineTo(x+w-thick, y+h-thick); ctx.lineTo(x+w-thick, y+thick); ctx.fill();
        // Bottom
        ctx.beginPath(); ctx.moveTo(x,y+h); ctx.lineTo(x+thick,y+h-thick); ctx.lineTo(x+w-thick, y+h-thick); ctx.lineTo(x+w, y+h); ctx.fill();
    }

    // V21 è¼”åŠ©ï¼šå™ªé»ç´‹ç†
    function drawNoise(ctx, x, y, w, h, alpha) {
        const iData = ctx.getImageData(x, y, w, h);
        for (let i = 0; i < iData.data.length; i += 4) {
            const noise = (Math.random() - 0.5) * 50 * alpha;
            iData.data[i] += noise; iData.data[i+1] += noise; iData.data[i+2] += noise;
        }
        ctx.putImageData(iData, x, y);
    }

    // V21 è¼”åŠ©ï¼šæœ¨ç´‹ç”Ÿæˆ
    function drawWoodGrain(ctx, w, h, color, intensity) {
        ctx.save();
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.globalAlpha = intensity;
        for(let i=0; i<w; i+=5) {
            ctx.beginPath();
            ctx.moveTo(i, 0);
            // ç•«å‡ºæ³¢æµªç·š
            for(let j=0; j<h; j+=20) {
                ctx.lineTo(i + Math.sin(j*0.05)*10 + (Math.random()-0.5)*2, j);
            }
            ctx.stroke();
        }
        ctx.restore();
    }

    function drawInnerShadow(ctx, x, y, w, h) {
        ctx.shadowColor = "rgba(0,0,0,0.7)"; ctx.shadowBlur = 30; ctx.shadowOffsetX = 5; ctx.shadowOffsetY = 5;
        ctx.strokeStyle = "rgba(0,0,0,0.1)"; ctx.lineWidth = 1; ctx.strokeRect(x, y, w, h); ctx.shadowBlur = 0;
    }

    function applyTextStyle(ctx, style, fontSize) {
        ctx.font = `bold ${fontSize}px "Microsoft JhengHei", sans-serif`;
        ctx.lineWidth = fontSize / 10; ctx.shadowBlur = 0; ctx.shadowColor = 'transparent';
        switch(style) {
            case 'calligraphy': ctx.fillStyle = 'white'; ctx.font = `bold ${fontSize*1.2}px "Kaiti SC", STKaiti, serif`; ctx.shadowColor="black"; ctx.shadowBlur=10; break;
            case 'neon': ctx.fillStyle = '#00eaff'; ctx.strokeStyle = '#ff00de'; ctx.shadowColor = '#00eaff'; ctx.shadowBlur = 20; ctx.lineWidth = 5; break;
            case 'comic': ctx.fillStyle = '#ffd700'; ctx.strokeStyle = 'black'; ctx.lineWidth = 8; ctx.font = `900 ${fontSize*1.1}px "Arial Black", sans-serif`; break;
            case 'cute': ctx.fillStyle = '#ff99cc'; ctx.font = `bold ${fontSize}px "Comic Sans MS", cursive`; ctx.shadowColor="white"; ctx.shadowBlur=5; break;
            case 'elegant': ctx.fillStyle = '#d4af37'; ctx.font = `italic bold ${fontSize}px serif`; ctx.shadowColor="#333"; ctx.shadowBlur=5; break;
            case 'typewriter': ctx.fillStyle = '#00ff00'; ctx.font = `${fontSize}px monospace`; ctx.shadowColor="black"; ctx.shadowBlur=2; break;
            case 'graffiti': ctx.fillStyle = 'white'; ctx.strokeStyle = '#ff3300'; ctx.lineWidth = 5; ctx.font = `900 ${fontSize*1.2}px sans-serif`; break;
            case 'headline': ctx.fillStyle = 'white'; ctx.strokeStyle = 'black'; ctx.lineWidth = 4; ctx.font = `900 ${fontSize*1.1}px impact, sans-serif`; break;
            case 'stone': ctx.fillStyle = '#888888'; ctx.strokeStyle = '#333333'; ctx.lineWidth = 3; ctx.shadowColor="black"; ctx.shadowBlur=2; ctx.shadowOffsetX=2; ctx.shadowOffsetY=2; break;
            case 'ink': ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.font = `bold ${fontSize}px "Kaiti SC", STKaiti, serif`; ctx.shadowColor="rgba(255,255,255,0.5)"; ctx.shadowBlur=5; break;
        }
    }

    function drawRealSeal(ctx, name, shape, fontStyle, rightX, bottomY) {
        const sealSize = Math.floor((rightX * 0.1)); 
        const margin = 40;
        const x = rightX - sealSize - margin;
        const y = bottomY - sealSize - margin;
        const center = sealSize / 2;

        ctx.save();
        ctx.translate(x, y);

        ctx.fillStyle = "#b30000"; 
        ctx.beginPath();
        if (shape === 'square') { ctx.rect(0, 0, sealSize, sealSize); }
        else if (shape === 'rect') { ctx.rect(0, sealSize*0.2, sealSize, sealSize*0.6); }
        else if (shape === 'circle') { ctx.arc(center, center, center, 0, Math.PI*2); }
        else if (shape === 'oval') { ctx.ellipse(center, center, center, center*0.6, 0, 0, Math.PI*2); }
        else if (shape === 'rounded') { 
            const r = 10; ctx.moveTo(r,0); ctx.lineTo(sealSize-r,0); ctx.quadraticCurveTo(sealSize,0,sealSize,r); 
            ctx.lineTo(sealSize,sealSize-r); ctx.quadraticCurveTo(sealSize,sealSize,sealSize-r,sealSize); 
            ctx.lineTo(r,sealSize); ctx.quadraticCurveTo(0,sealSize,0,sealSize-r); 
            ctx.lineTo(0,r); ctx.quadraticCurveTo(0,0,r,0); 
        }
        ctx.fill();

        ctx.globalCompositeOperation = 'source-atop';
        ctx.fillStyle = 'rgba(0,0,0,0.1)';
        for(let i=0; i<50; i++) ctx.fillRect(Math.random()*sealSize, Math.random()*sealSize, 2, 2);
        ctx.globalCompositeOperation = 'source-over';

        let fontName = "sans-serif"; let fontWeight = "bold"; let fontScale = 0.6; 
        switch(fontStyle) {
            case 'standard': fontName = '"Microsoft JhengHei", sans-serif'; break;
            case 'serif_bold': fontName = '"Songti SC", serif'; fontWeight="900"; break;
            case 'cursive': fontName = '"Kaiti SC", cursive'; fontWeight="normal"; break;
            case 'heavy': fontName = '"Arial Black", sans-serif'; break;
            case 'thin': fontName = '"MingLiU", serif'; fontWeight="100"; break;
            case 'old': fontName = '"LiSu", "Kaiti SC", serif'; break;
            case 'seal_script': fontName = '"SimSun", serif'; fontScale=0.7; break;
            case 'rough': fontName = '"Courier New", monospace'; break;
            case 'ink_bleed': fontName = '"Kaiti SC", serif'; ctx.shadowColor="#b30000"; ctx.shadowBlur=2; break;
            case 'modern': fontName = 'Arial, sans-serif'; fontWeight="100"; fontScale=0.5; break;
        }

        ctx.fillStyle = "white"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        let displayTxt = name; let fontSize = sealSize * fontScale;
        
        if (name.length <= 2) {
            ctx.font = `${fontWeight} ${fontSize}px ${fontName}`; ctx.fillText(name, center, center);
        } else {
            fontSize = sealSize * (fontScale * 0.6);
            ctx.font = `${fontWeight} ${fontSize}px ${fontName}`;
            if (shape === 'rect' || shape === 'oval') { ctx.fillText(name, center, center); } 
            else {
                const mid = Math.ceil(name.length / 2);
                const line1 = name.substring(0, mid);
                const line2 = name.substring(mid);
                ctx.fillText(line1, center + fontSize*0.3, center - fontSize*0.5); 
                ctx.fillText(line2, center - fontSize*0.3, center + fontSize*0.5);
            }
        }
        ctx.restore();
    }

    function generateAI(styleKey) {
        if (isUploadMode) return;
        composeFinalImage(null, "âš¡ AI ç¹ªåœ–èˆ‡è£è£±ä¸­..."); 
        document.getElementById('prompt-debug').innerText = "AI æŒ‡ä»¤é‹ç®—ä¸­...";

        let genderBase = currentGender === 'boy' ? "handsome man, male" : "beautiful woman, female";
        let detailPrompt = getDetails(); 
        let fullPrompt = "";
        if(styleKey === 'pixar') fullPrompt = `cute 3d pixar style ${genderBase}, ${detailPrompt}, studio lighting, big eyes, 8k`;
        else if(styleKey === 'ghibli') fullPrompt = `studio ghibli anime portrait of ${genderBase}, ${detailPrompt}, hayao miyazaki style, watercolor background`;
        else if(styleKey === 'cyberpunk') fullPrompt = `cyberpunk portrait of ${genderBase}, ${detailPrompt}, neon lights, mechanical parts, futuristic city`;
        else if(styleKey === 'oil') fullPrompt = `van gogh oil painting portrait of ${genderBase}, ${detailPrompt}, thick brushstrokes, artistic, starry night`;
        else if(styleKey === 'comic') fullPrompt = `american comic superhero ${genderBase}, ${detailPrompt}, bold lines, halftone dots, marvel style`;
        else if(styleKey === 'ink') fullPrompt = `chinese ink wash painting portrait of ${genderBase}, ${detailPrompt}, black and white, sumi-e, artistic, red stamp`;
        else if(styleKey === 'real') fullPrompt = `(masterpiece), best quality, realistic photo of a ${genderBase}, ${detailPrompt}, highly detailed face, dslr, 8k, raw photo, soft lighting, looking at camera`;
        else if(styleKey === 'taoist') fullPrompt = `(masterpiece), traditional chinese ancient style portrait of ${genderBase}, ${detailPrompt}, righteous aura, ethereal atmosphere, soft lighting, hd, 8k`;
        
        const aiUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(fullPrompt)}?width=1024&height=1024&seed=${Math.floor(Math.random()*9999)}&nologo=true`;
        
        setTimeout(() => { composeFinalImage(aiUrl, "âš¡ AI ç¹ªåœ–èˆ‡è£è£±ä¸­..."); }, 100);
    }
    
    function simulateProgress() { const bar = document.getElementById('progress-bar'); let w = 0; const int = setInterval(() => { if(w>=90) clearInterval(int); w+=10; bar.style.width=w+'%'; }, 300); }
    function switchStage(id) { document.querySelectorAll('.stage').forEach(el => { el.style.display = 'none'; el.classList.remove('active'); }); const target = document.getElementById(id); target.style.display = 'flex'; setTimeout(()=>target.classList.add('active'), 10); }
</script>
</body>
</html>