<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Live Mirror AI - V39.1 Elf</title>
    <style>
        /* M28 è¦–è¦ºå‚³æ’­ï¼šæ¥µç°¡é»‘é‡‘é¢¨æ ¼ */
        :root { --bg-color: #050505; --panel-bg: #111111; --accent-color: #c5a059; --text-accent: #ff6b6b; --text-primary: #e0e0e0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: "Microsoft JhengHei", sans-serif; background: var(--bg-color); color: var(--text-primary); display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #app-window { width: 100%; height: 100dvh; max-width: 500px; background: var(--panel-bg); display: flex; flex-direction: column; position: relative; overflow: hidden; box-shadow: 0 0 60px rgba(0,0,0,0.9); }
        
        header { padding: 12px; text-align: center; border-bottom: 1px solid #222; font-weight: bold; flex: none; font-size: 16px; display: flex; justify-content: center; align-items: center; gap: 8px; color: var(--accent-color); letter-spacing: 1px; }
        .version-tag { font-size: 10px; background: linear-gradient(45deg, var(--accent-color), #ffd700); padding: 2px 6px; border-radius: 4px; color: #000; font-weight: 900; }

        .stage { flex: 1; display: none; flex-direction: column; align-items: center; padding: 15px; overflow-y: auto; overflow-x: hidden; }
        .active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .viewport-container { width: 100%; background: #000; border-radius: 12px; overflow: hidden; position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; flex: none; border: 1px solid #333; min-height: 250px; }
        
        #preview-img, #final-result { width: 100%; height: 100%; object-fit: contain; display: none; }
        #preview-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: #080808; }
        .placeholder-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }

        /* V39: ç°¡åŒ–æŒ‰éˆ•å€ï¼Œåªå‰©ä¸€å€‹ */
        .btn-group { display: flex; width: 100%; justify-content: center; margin-top: 20px; }
        .btn-action { padding: 0; height: 50px; line-height: 50px; border-radius: 25px; border: none; background: linear-gradient(135deg, var(--accent-color), #aa8a2e); color: #000; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(197, 160, 89, 0.3); width: 100%; max-width: 220px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: transform 0.1s; outline: none; }
        .btn-action:active { transform: scale(0.96); }
        
        #start-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        select.camera-select { width: 100%; padding: 10px; margin-bottom: 15px; background: #333; color: white; border: 1px solid #555; border-radius: 8px; font-size: 14px; outline: none; }
        
        .style-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; width: 100%; padding-bottom: 30px;}
        .style-card { background: #2a2a2a; border: 1px solid #444; border-radius: 10px; padding: 15px 5px; cursor: pointer; text-align: center; font-size: 14px; position: relative; overflow: hidden; transition: all 0.2s; }
        .style-card:active { transform: scale(0.96); background: #444; }
        /* V39.1 ä¿®æ”¹æ¨£å¼åç¨± */
        .style-elf { border: 1px solid var(--accent-color); background: rgba(197, 160, 89, 0.1); }
        .style-tao { border: 1px solid #fff; background: linear-gradient(45deg, #2a2a2a, #555); }

        #canvas-comp, #canvas-resize, #canvas { display: none !important; }
        
        .progress-wrapper { width: 80%; position: relative; margin-top: 30px; }
        .progress-text { position: absolute; top: -22px; right: 0; color: var(--accent-color); font-weight: bold; font-size: 13px; }
    </style>
</head>
<body>

<div id="app-window">
    <header>
        Live Mirror AI <span class="version-tag">V39.1 Elf</span>
    </header>

    <div id="start-overlay">
        <h1 style="color:white; margin-bottom:10px; font-size: 24px;">ğŸ‘‹ æ­¡è¿é«”é©—</h1>
        <p style="color:#aaa; margin-bottom:30px; font-size: 14px;">V39.1 è™›å¹»ç²¾éˆç‰ˆ</p>
        <div id="btn-container" class="btn-group">
            <button class="btn-action" onclick="initCameraMode()">ğŸ“¸ å•Ÿå‹•ç›¸æ©Ÿ</button>
        </div>
        <div id="step-selection" style="display:none; width:100%; margin-top: 20px;">
            <p style="color:white; margin-bottom:15px;">è«‹é¸æ“‡é¡é ­ï¼š</p>
            <select id="camera-list" class="camera-select"></select>
            <div style="display:flex; justify-content:center;"><button class="btn-action" onclick="confirmCamera()">âœ… ç¢ºèª</button></div>
        </div>
        <p id="error-msg" style="color: #ff5c5c; font-size: 12px; margin-top: 20px; max-width: 80%;"></p>
    </div>

    <div id="stage-1" class="stage">
        <div class="viewport-container" style="max-height: 60vh;">
            <video id="webcam" playsinline class="mirror" autoplay style="width: 100%; height: 100%; object-fit: cover; display: block;"></video>
        </div>
        <button class="btn-action" onclick="capturePhoto()">ğŸ“¸ æ‹ ç…§</button>
        <p style="margin-top:20px; font-size:14px; color:#666; cursor:pointer; text-decoration: underline;" onclick="location.reload()">[è¿”å›é¦–é ]</p>
    </div>

    <div id="stage-2" class="stage">
        <div class="viewport-container" style="height: 300px; border: 2px solid var(--accent-color); background: #000;">
            <div id="preview-placeholder">
                <div class="placeholder-icon">ğŸ–¼ï¸</div>
                <span>ç­‰å¾…ç…§ç‰‡è¼‰å…¥...</span>
            </div>
            <img id="preview-img" src="">
        </div>
        
        <h3 style="width:100%; font-size:14px; color:#888; margin-bottom:15px; margin-top:10px; text-align:center;">âœ¨ é¸æ“‡ AI é¢¨æ ¼ (é»æ“Šç”Ÿæˆ)</h3>
        <div class="style-grid">
            <div class="style-card style-elf" onclick="generateAI('elf')">ğŸ§š è™›å¹»ç²¾éˆ</div>
            <div class="style-card style-tao" onclick="generateAI('taoist')">ğŸ•Šï¸ ç™½é™½è–æ½”</div>
            <div class="style-card" onclick="generateAI('pixar')">ğŸ§¸ çš®å…‹æ–¯é¢¨</div>
            <div class="style-card" onclick="generateAI('ghibli')">ğŸƒ å‰åœåŠ›é¢¨</div>
            <div class="style-card" onclick="generateAI('cyberpunk')">ğŸŒƒ è³½åšé¾å…‹</div>
            <div class="style-card" onclick="generateAI('oil')">ğŸ¨ æ¢µè°·æ²¹ç•«</div>
            <div class="style-card" onclick="generateAI('comic')">ğŸ’¥ ç¾å¼æ¼«ç•«</div>
            <div class="style-card" onclick="generateAI('ink')">ğŸ–Œï¸ æ±æ–¹æ°´å¢¨</div>
        </div>

        <button style="margin-top:5px; background:transparent; border:none; color:#666; font-size:14px;" onclick="location.reload()">â¬…ï¸ è¿”å›é‡æ‹</button>
    </div>

    <div id="stage-3" class="stage" style="justify-content: center;">
        <h2 id="loading-text" style="color: var(--accent-color); font-size: 22px;">âš¡ è™•ç†ä¸­...</h2>
        <div class="progress-wrapper">
            <span id="progress-percent" class="progress-text">0%</span>
            <div style="width:100%; height:8px; background:#333; border-radius:4px; overflow: hidden;">
                <div id="progress-bar" style="width:0%; height:100%; background: linear-gradient(90deg, var(--accent-color), #fff); transition:width 0.3s;"></div>
            </div>
        </div>
        <p id="prompt-debug" style="color:#888; font-size:12px; margin-top:15px; max-width:80%; text-align:center;">æ­£åœ¨åˆå§‹åŒ–...</p>
    </div>

    <div id="stage-4" class="stage">
        <h2 style="color: var(--accent-color); font-size: 22px;">âœ¨ æ‚¨çš„å°ˆå±¬ä½œå“</h2>
        <div class="viewport-container" style="background: transparent; border: none; min-height: 300px; height: auto; padding: 10px;">
            <div id="result-placeholder" style="display:block; color:#555;">æ­£åœ¨è£è£±...</div>
            <img id="final-result" src="" style="box-shadow: 0 10px 40px rgba(0,0,0,0.7); width: auto; height: auto; max-width: 100%; max-height: 65vh;">
        </div>
        <p style="color: var(--accent-color); font-weight: bold; font-size: 16px; margin-top: 15px;">ğŸ‘‡ é•·æŒ‰åœ–ç‰‡å„²å­˜ ğŸ‘‡</p>
        <div style="font-size: 13px; color: #888; margin-top: 20px; border-top: 1px solid #333; padding-top: 15px; width: 100%; text-align: center;">
            åˆ†äº«é€£çµï¼š
            <div id="qrcode-container" style="margin-top: 10px; background: white; padding: 10px; display: inline-block; border-radius: 12px;"></div>
        </div>
        <button class="btn-action" onclick="location.reload()" style="background: #333; color:white; font-size:15px; margin-top: 30px; max-width:none; border: 1px solid #555; padding: 12px 0;">ğŸ”„ å†ç©ä¸€æ¬¡</button>
    </div>

    <canvas id="canvas-comp"></canvas>
    <canvas id="canvas-resize"></canvas>
    <canvas id="canvas"></canvas>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    const video = document.getElementById('webcam'), previewImg = document.getElementById('preview-img'), finalImg = document.getElementById('final-result'), cameraList = document.getElementById('camera-list'), errorMsg = document.getElementById('error-msg');
    const canvasComp = document.getElementById('canvas-comp'); const canvasResize = document.getElementById('canvas-resize');
    let loadingTimer; let retryCount = 0; const maxRetries = 3; let progressInterval;

    window.onerror = function(msg, url, line, col, error) {
        console.error("Global Error:", msg, error);
        if(document.getElementById('stage-3').style.display === 'flex') {
            composeDirectly("âš ï¸ ç³»çµ±å¿™ç¢Œï¼Œå·²ç‚ºæ‚¨åˆ‡æ›è‡³å¿«é€Ÿæ¨¡å¼");
        }
    };

    async function initCameraMode() {
        errorMsg.innerText = "";
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            await listCameras();
            stream.getTracks().forEach(track => track.stop());
            document.getElementById('btn-container').style.display = 'none';
            document.getElementById('step-selection').style.display = 'block';
        } catch (err) { console.error(err); errorMsg.innerText = "å•Ÿå‹•å¤±æ•—ï¼šè«‹ç¢ºèªç€è¦½å™¨å·²å…è¨±ç›¸æ©Ÿæ¬Šé™(NotAllowedError)ã€‚"; }
    }

    async function listCameras() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        cameraList.innerHTML = '';
        videoDevices.forEach((device, index) => {
            const option = document.createElement('option'); option.value = device.deviceId;
            let label = device.label || `ç›¸æ©Ÿ ${index + 1}`;
            if (label.toLowerCase().includes('back') || label.includes('å¾Œ')) label = "ğŸ“¸ å¾Œç½®é¡é ­"; else if (label.toLowerCase().includes('front') || label.includes('å‰')) label = "ğŸ‘¤ å‰ç½®è‡ªæ‹";
            option.text = label; cameraList.appendChild(option);
        });
    }

    async function confirmCamera() {
        const deviceId = cameraList.value;
        const constraints = { video: { deviceId: { exact: deviceId }, width: { ideal: 1920 }, height: { ideal: 1080 } } };
        try { const stream = await navigator.mediaDevices.getUserMedia(constraints); video.srcObject = stream; document.getElementById('start-overlay').style.display = 'none'; switchStage('stage-1'); } catch (err) { 
            try { const stream = await navigator.mediaDevices.getUserMedia({ video: true }); video.srcObject = stream; document.getElementById('start-overlay').style.display = 'none'; switchStage('stage-1'); } catch (fatalErr) { alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®šã€‚"); } 
        }
    }

    function processInputImage(imgElement, isCamera = false) {
        const MAX_WORK_SIZE = 1200; 
        let w = imgElement.width; let h = imgElement.height;
        if (w > h) { if (w > MAX_WORK_SIZE) { h *= MAX_WORK_SIZE / w; w = MAX_WORK_SIZE; } } 
        else { if (h > MAX_WORK_SIZE) { w *= MAX_WORK_SIZE / h; h = MAX_WORK_SIZE; } }
        canvasResize.width = w; canvasResize.height = h;
        const ctx = canvasResize.getContext('2d');
        if (isCamera) { ctx.translate(w, 0); ctx.scale(-1, 1); }
        ctx.drawImage(imgElement, 0, 0, w, h);
        previewImg.src = canvasResize.toDataURL('image/jpeg', 0.95);
        previewImg.style.display = 'block';
        document.getElementById('preview-placeholder').style.display = 'none';
        document.getElementById('start-overlay').style.display = 'none'; 
        switchStage('stage-2');
    }

    function capturePhoto() { processInputImage(video, true); }

    // V39: ç°¡åŒ–å¾Œçš„ AI ç”Ÿæˆï¼Œç§»é™¤æ€§åˆ¥èˆ‡ç´°ç¯€ï¼Œä½¿ç”¨é€šç”¨ Prompt
    function generateAI(styleKey) { 
        switchStage('stage-3');
        document.getElementById('loading-text').innerText = "âš¡ AI ç¹ªåœ–ä¸­...";
        simulateProgress();
        retryCount = 0;
        tryLoadAI(styleKey, 768, 1024);
    }

    function tryLoadAI(styleKey, width, height) {
        // V39.1: ä¿®æ”¹ Prompt
        let fullPrompt = ""; 
        if(styleKey === 'pixar') fullPrompt = `cute 3d pixar style portrait, highly detailed, studio lighting, big eyes, 8k`; 
        else if(styleKey === 'ghibli') fullPrompt = `studio ghibli anime portrait, hayao miyazaki style, watercolor background, high quality`; 
        else if(styleKey === 'cyberpunk') fullPrompt = `cyberpunk portrait, neon lights, mechanical parts, futuristic city background, realistic`; 
        else if(styleKey === 'oil') fullPrompt = `van gogh oil painting portrait, thick brushstrokes, artistic, starry night background`; 
        else if(styleKey === 'comic') fullPrompt = `american comic superhero portrait, bold lines, halftone dots, marvel style`; 
        else if(styleKey === 'ink') fullPrompt = `chinese ink wash painting portrait, black and white, sumi-e, artistic, red stamp`; 
        // V39.1: æ–°å¢è™›å¹»ç²¾éˆ Prompt
        else if(styleKey === 'elf') fullPrompt = `(masterpiece), best quality, ethereal fantasy portrait, beautiful elf spirit with pointed ears, glowing skin, magical forest background with bioluminescent lights, dreamy atmosphere, highly detailed, 8k`; 
        else if(styleKey === 'taoist') fullPrompt = `(masterpiece), traditional chinese ancient style portrait, righteous aura, ethereal atmosphere, soft lighting, hd, 8k, hanfu`; 
        
        const ratio = previewImg.naturalWidth / previewImg.naturalHeight;
        let aiW = width, aiH = height;
        if (ratio > 1.1) { [aiW, aiH] = [height, width]; } 

        const aiUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(fullPrompt)}?width=${aiW}&height=${aiH}&seed=${Math.floor(Math.random()*999999)}&nologo=true&model=flux&t=${Date.now()}`; 
        
        const tempImg = new Image();
        tempImg.crossOrigin = "anonymous";
        
        const watchdog = setTimeout(() => { handleAILoadError(styleKey, "è¶…æ™‚"); }, 60000);

        tempImg.onload = () => {
            clearTimeout(watchdog);
            composeFinalImage(aiUrl, "âš¡ AI ç¹ªåœ–å®Œæˆ...");
        };

        tempImg.onerror = () => {
            clearTimeout(watchdog);
            handleAILoadError(styleKey, "è¼‰å…¥å¤±æ•—");
        };
        tempImg.src = aiUrl;
    }

    function handleAILoadError(styleKey, reason) {
        retryCount++;
        const debug = document.getElementById('prompt-debug');
        if (retryCount === 1) {
            debug.innerText = `é€£ç·šç¹å¿™ï¼Œé™ç´šé‡è©¦ä¸­ (1/3)...`;
            setTimeout(() => { tryLoadAI(styleKey, 512, 768); }, 1000);
        } else if (retryCount === 2) {
            debug.innerText = `ä¼ºæœå™¨æ“å¡ï¼Œæ¥µé€Ÿæ¨¡å¼é‡è©¦ (2/3)...`;
            setTimeout(() => { tryLoadAI(styleKey, 384, 512); }, 1000);
        } else {
            debug.innerText = "AI å¿™ç·šï¼Œå·²åˆ‡æ›è‡³åŸåœ–è£è£±...";
            setTimeout(() => { composeDirectly("âš ï¸ AI å¿™ç·šï¼Œå·²ç‚ºæ‚¨ä½¿ç”¨åŸåœ–"); }, 1000);
        }
    }

    function composeFinalImage(sourceImageUrl, loadingMsg) {
        document.getElementById('loading-text').innerText = loadingMsg || "âš¡ è™•ç†ä¸­..."; 
        document.getElementById('prompt-debug').innerText = "å½±åƒåˆæˆä¸­...";
        
        const baseImg = new Image();
        if (sourceImageUrl.startsWith('http')) { baseImg.crossOrigin = "anonymous"; }
        
        baseImg.onload = () => { processComposition(baseImg); };
        baseImg.onerror = () => { composeDirectly("âš ï¸ å½±åƒè™•ç†ç•°å¸¸ï¼Œä½¿ç”¨åŸåœ–å‚™ä»½"); }; 
        baseImg.src = sourceImageUrl;
    }

    function composeDirectly(loadingMsg) {
        document.getElementById('loading-text').innerText = loadingMsg;
        setTimeout(() => {
            const fallbackImg = new Image();
            fallbackImg.onload = () => { processComposition(fallbackImg); };
            fallbackImg.src = previewImg.src;
        }, 100);
    }

    // V39: æ¥µç°¡åˆæˆ (ç´”åœ–ï¼Œç„¡é‚Šæ¡†æ–‡å­—)
    function processComposition(imageSource) {
        try {
            const workW = imageSource.width;
            const workH = imageSource.height;

            canvasComp.width = workW; 
            canvasComp.height = workH;
            const ctx = canvasComp.getContext('2d');

            // ç°¡å–®ç›´æ¥ç¹ªè£½åœ–ç‰‡
            ctx.drawImage(imageSource, 0, 0);
            
            finalImg.src = canvasComp.toDataURL('image/png'); 
            finalImg.style.display = 'block';
            document.getElementById('result-placeholder').style.display = 'none';
            
            if(typeof progressInterval !== 'undefined') clearInterval(progressInterval);
            document.getElementById('progress-bar').style.width = '100%';
            
            document.getElementById('loading-text').innerText = "å®Œæˆï¼";
            setTimeout(() => {
                 document.getElementById("qrcode-container").innerHTML = ""; 
                 new QRCode(document.getElementById("qrcode-container"), { text: window.location.href, width: 120, height: 120 }); 
                 switchStage('stage-4');
            }, 100);

        } catch (e) {
            console.error(e);
            finalImg.src = previewImg.src;
            finalImg.style.display = 'block';
            switchStage('stage-4');
        }
    }

    function simulateProgress() { const bar = document.getElementById('progress-bar'); const text = document.getElementById('progress-percent'); const debug = document.getElementById('prompt-debug'); let w = 0; progressInterval = setInterval(() => { if(w>=99) clearInterval(progressInterval); if(w < 50) w += Math.random() * 5; else if(w < 80) w += Math.random() * 2; else w += Math.random() * 0.5; w = Math.min(w, 99); bar.style.width = w + '%'; text.innerText = Math.floor(w) + '%'; if(w < 30) debug.innerText = "æ­£åœ¨æ§‹æ€ç•«é¢ç´°ç¯€..."; else if(w < 60) debug.innerText = "AI å¤§å¸«æ®æ¯«ä¸­..."; else if(w < 90) debug.innerText = "æ­£åœ¨é€²è¡Œå…‰å½±æ¸²æŸ“..."; else debug.innerText = "æœ€å¾Œä¿®é£¾..."; }, 500); }
    function switchStage(id) { document.querySelectorAll('.stage').forEach(el => { el.style.display = 'none'; el.classList.remove('active'); }); const target = document.getElementById(id); target.style.display = 'flex'; setTimeout(()=>target.classList.add('active'), 10); }
</script>
</body>
</html>