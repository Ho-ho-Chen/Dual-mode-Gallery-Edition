<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Live Mirror AI - V33.0 Stable</title>
    <style>
        /* M28 è¦–è¦ºå‚³æ’­ï¼šé»‘é‡‘è—å»Šé¢¨æ ¼ */
        :root { --bg-color: #050505; --panel-bg: #111111; --accent-color: #c5a059; --text-accent: #ff6b6b; --text-primary: #e0e0e0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: "Microsoft JhengHei", sans-serif; background: var(--bg-color); color: var(--text-primary); display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #app-window { width: 100%; height: 100dvh; max-width: 500px; background: var(--panel-bg); display: flex; flex-direction: column; position: relative; overflow: hidden; box-shadow: 0 0 60px rgba(0,0,0,0.9); }
        
        header { padding: 12px; text-align: center; border-bottom: 1px solid #222; font-weight: bold; flex: none; font-size: 16px; display: flex; justify-content: center; align-items: center; gap: 8px; color: var(--accent-color); letter-spacing: 1px; }
        .version-tag { font-size: 10px; background: linear-gradient(45deg, var(--accent-color), #ffd700); padding: 2px 6px; border-radius: 4px; color: #000; font-weight: 900; }

        .stage { flex: 1; display: none; flex-direction: column; align-items: center; padding: 15px; overflow-y: auto; overflow-x: hidden; }
        .active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .viewport-container { width: 100%; background: #000; border-radius: 12px; overflow: hidden; position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; flex: none; border: 1px solid #333; min-height: 250px; }
        
        #preview-img, #final-result { width: 100%; height: 100%; object-fit: contain; display: none; }
        #preview-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: #080808; }
        .placeholder-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }

        .btn-group { display: flex; gap: 15px; width: 100%; justify-content: center; margin-top: 20px; }
        .btn-action { padding: 0; height: 45px; line-height: 45px; border-radius: 25px; border: none; background: linear-gradient(135deg, var(--accent-color), #aa8a2e); color: #000; font-size: 15px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(197, 160, 89, 0.3); width: 100%; max-width: 160px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: transform 0.1s; outline: none; }
        .btn-action:active { transform: scale(0.96); }
        .btn-upload { background: #333; color: white; border: 1px solid #444; box-shadow: none; }
        .btn-direct-frame { background: linear-gradient(135deg, #ff6b6b, #c0392b); color: white; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); width: 200px; }

        .control-panel { width: 100%; background: #1a1a1a; padding: 12px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; }
        .panel-title { font-size: 13px; color: var(--accent-color); margin-bottom: 10px; font-weight: bold; display: flex; align-items: center; gap: 5px; text-transform: uppercase; }
        
        .ai-only-section { display: block; }
        .upload-mode .ai-only-section { display: none !important; }

        #text-preview-canvas { width: 100%; height: 80px; background: #222; border: 1px dashed #444; border-radius: 8px; margin-bottom: 10px; display: block; }
        .detail-textarea { width: 100%; padding: 10px; background: #252525; color: white; border: 1px solid #444; border-radius: 8px; font-size: 14px; outline: none; margin-bottom: 10px; resize: none; font-family: inherit; }
        .detail-input { width: 100%; padding: 10px; background: #252525; color: white; border: 1px solid #444; border-radius: 8px; font-size: 14px; outline: none; margin-bottom: 10px; }
        .detail-input:focus, .detail-textarea:focus { border-color: var(--accent-color); }

        .select-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .select-group { display: flex; flex-direction: column; gap: 4px; }
        .select-label { font-size: 11px; color: #888; margin-left: 2px; font-weight: bold; }
        select.detail-select { width: 100%; padding: 8px; background: #252525; color: white; border: 1px solid #444; border-radius: 8px; font-size: 13px; outline: none; appearance: none; transition: border 0.3s; }
        select.detail-select:focus { border-color: var(--accent-color); }

        .slider-container { display: flex; align-items: center; gap: 10px; }
        input[type=range] { flex: 1; -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--accent-color); cursor: pointer; margin-top: -6px; border: 2px solid #fff; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #444; border-radius: 2px; }
        #text-size-display { color: var(--accent-color); font-size: 12px; width: 30px; text-align: right; }

        #start-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        select.camera-select { width: 100%; padding: 10px; margin-bottom: 15px; background: #333; color: white; border: 1px solid #555; border-radius: 8px; font-size: 14px; outline: none; }
        
        .style-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; width: 100%; padding-bottom: 30px;}
        .style-card { background: #2a2a2a; border: 1px solid #444; border-radius: 10px; padding: 10px 5px; cursor: pointer; text-align: center; font-size: 13px; position: relative; overflow: hidden; transition: all 0.2s; }
        .style-card:active { transform: scale(0.96); background: #444; }
        .style-real { border: 1px solid var(--accent-color); background: rgba(197, 160, 89, 0.1); }
        .style-tao { border: 1px solid #fff; background: linear-gradient(45deg, #2a2a2a, #555); }

        .gender-toggle { display: flex; gap: 8px; margin-bottom: 15px; width: 100%; }
        .gender-option { flex: 1; text-align: center; padding: 10px; background: #252525; border-radius: 10px; border: 1px solid #444; cursor: pointer; font-weight: bold; color: #888; font-size: 13px; transition: all 0.3s; }
        .gender-option.selected { background: var(--accent-color); color: #000; border-color: var(--accent-color); }
        
        #canvas-comp, #canvas-resize, #canvas { display: none !important; }
        #file-input { display: none; }
        
        .progress-wrapper { width: 80%; position: relative; margin-top: 30px; }
        .progress-text { position: absolute; top: -22px; right: 0; color: var(--accent-color); font-weight: bold; font-size: 13px; }
    </style>
</head>
<body>

<div id="app-window">
    <header>
        Live Mirror AI <span class="version-tag">V33.0</span>
    </header>

    <div id="start-overlay">
        <h1 style="color:white; margin-bottom:10px; font-size: 24px;">ğŸ‘‹ æ­¡è¿é«”é©—</h1>
        <p style="color:#aaa; margin-bottom:30px; font-size: 14px;">V33.0 é‡‘å‰›ä¸å£ç‰ˆ</p>
        <div id="btn-container" class="btn-group">
            <button class="btn-action" onclick="initCameraMode()">ğŸ“¸ å•Ÿå‹•ç›¸æ©Ÿ</button>
            <button class="btn-action btn-upload" onclick="triggerUpload()">ğŸ“ ä¸Šå‚³ç…§ç‰‡</button>
        </div>
        <div id="step-selection" style="display:none; width:100%; margin-top: 20px;">
            <p style="color:white; margin-bottom:15px;">è«‹é¸æ“‡é¡é ­ï¼š</p>
            <select id="camera-list" class="camera-select"></select>
            <div style="display:flex; justify-content:center;"><button class="btn-action" onclick="confirmCamera()">âœ… ç¢ºèª</button></div>
        </div>
        <p id="error-msg" style="color: #ff5c5c; font-size: 12px; margin-top: 20px; max-width: 80%;"></p>
    </div>
    
    <input type="file" id="file-input" accept="image/*">

    <div id="stage-1" class="stage">
        <div class="viewport-container" style="max-height: 60vh;">
            <video id="webcam" playsinline class="mirror" autoplay style="width: 100%; height: 100%; object-fit: cover; display: block;"></video>
        </div>
        <button class="btn-action" onclick="capturePhoto()" style="width: 200px; max-width: none;">ğŸ“¸ æ‹ ç…§</button>
        <p style="margin-top:20px; font-size:14px; color:#666; cursor:pointer; text-decoration: underline;" onclick="location.reload()">[è¿”å›é¦–é ]</p>
    </div>

    <div id="stage-2" class="stage">
        <div class="viewport-container" style="height: 300px; border: 2px solid var(--accent-color); background: #000;">
            <div id="preview-placeholder">
                <div class="placeholder-icon">ğŸ–¼ï¸</div>
                <span>ç­‰å¾…ç…§ç‰‡è¼‰å…¥...</span>
            </div>
            <img id="preview-img" src="">
        </div>
        
        <div class="ai-only-section">
            <div class="gender-toggle">
                <div class="gender-option" onclick="switchGender('boy')" id="btn-boy">ğŸ‘¦ ç”·ç”Ÿ</div>
                <div class="gender-option selected" onclick="switchGender('girl')" id="btn-girl">ğŸ‘§ å¥³ç”Ÿ</div>
            </div>
            <div class="control-panel"><div class="panel-title">ğŸ¬ å°æ¼”æŒ‡ä»¤ (AIè¨­å®š)</div><div class="select-grid"><div class="select-group"><span class="select-label">ğŸ‘— æœè£</span><select id="opt-clothes" class="detail-select"></select></div><div class="select-group"><span class="select-label">ğŸ’‡ é«®å‹</span><select id="opt-hair" class="detail-select"></select></div><div class="select-group"><span class="select-label">ğŸ‘‘ é ­é£¾</span><select id="opt-headwear" class="detail-select"></select></div><div class="select-group"><span class="select-label">ğŸ¤² æ‰‹æŒç‰©å“</span><select id="opt-held" class="detail-select"></select></div><div class="select-group"><span class="select-label">ğŸ“ åœ°é»</span><select id="opt-location" class="detail-select"><option value="">(éš¨æ©Ÿ)</option><option value="in a forest">æ£®æ—</option><option value="at the beach">æµ·é‚Š</option><option value="in a cyberpunk city">æœªä¾†åŸå¸‚</option><option value="in an ancient temple">å¤è€å»Ÿå®‡</option><option value="in a classroom">æ•™å®¤</option><option value="in outer space">å¤–å¤ªç©º</option><option value="in a library">åœ–æ›¸é¤¨</option><option value="in a flower field">æµªæ¼«èŠ±æµ·</option><option value="on a snowy mountain">é›ªå±±ä¹‹å·”</option><option value="on a concert stage">æ¼”å”±æœƒèˆå°</option></select></div><div class="select-group"><span class="select-label">ğŸŒ¤ï¸ å¤©æ°£/æ°›åœ</span><select id="opt-weather" class="detail-select"><option value="">(éš¨æ©Ÿ)</option><option value="sunny day, bright lighting">é™½å…‰ç‡¦çˆ›</option><option value="raining, cinematic lighting">ä¸‹é›¨é›»å½±æ„Ÿ</option><option value="starry night">æ˜Ÿç©ºå¤œæ™š</option><option value="sunset, golden hour">é»ƒæ˜é‡‘å…‰</option><option value="foggy, mysterious">éœ§æ°£ç¥ç§˜</option><option value="cherry blossoms falling">æ«»èŠ±é›¨</option><option value="northern lights sky">æ¥µå…‰</option><option value="rainbow in sky">å½©è™¹</option><option value="thunderstorm background">é›·é›»äº¤åŠ </option></select></div></div></div>
        </div>

        <div class="control-panel" style="border-color: #555;">
            <div class="panel-title" style="color: #eee;">âœï¸ å¤§å¸«é¡Œå­—èˆ‡è£è£±</div>
            <div style="display: flex; flex-direction: column;">
                <span class="select-label" style="margin-bottom: 5px;">ğŸ‘ï¸ æ–‡å­—æ¨£å¼é è¦½ (å³æ™‚)</span>
                <canvas id="text-preview-canvas" width="350" height="80"></canvas>

                <div class="select-group" style="margin-bottom: 10px;">
                    <span class="select-label">ğŸ“œ åè¨€ä½³å¥ (é¸å¡«)</span>
                    <select id="quote-select" class="detail-select" onchange="fillQuote()">
                        <option value="">(è‡ªè¡Œè¼¸å…¥æˆ–é¸æ“‡...)</option>
                        <optgroup label="--- äººç”Ÿå“²ç† ---"><option value="æ­²æœˆéœå¥½ï¼Œç¾ä¸–å®‰ç©©ã€‚">æ­²æœˆéœå¥½ï¼Œç¾ä¸–å®‰ç©©ã€‚</option><option value="å¿ƒä¹‹æ‰€å‘ï¼Œç´ å±¥ä»¥å¾€ã€‚">å¿ƒä¹‹æ‰€å‘ï¼Œç´ å±¥ä»¥å¾€ã€‚</option><option value="äººç”Ÿå¦‚é€†æ—…ï¼Œæˆ‘äº¦æ˜¯è¡Œäººã€‚">äººç”Ÿå¦‚é€†æ—…ï¼Œæˆ‘äº¦æ˜¯è¡Œäººã€‚</option></optgroup>
                        <optgroup label="--- è—è¡“å”¯ç¾ ---"><option value="ä½ è‹¥ç››é–‹ï¼Œè´è¶è‡ªä¾†ã€‚">ä½ è‹¥ç››é–‹ï¼Œè´è¶è‡ªä¾†ã€‚</option><option value="çœ¼ä¸­è‹¥æœ‰ç¾ï¼Œæ»¿ç›®çš†æ˜¯ç•«ã€‚">çœ¼ä¸­è‹¥æœ‰ç¾ï¼Œæ»¿ç›®çš†æ˜¯ç•«ã€‚</option><option value="æ•æ‰å…‰å½±ï¼Œç•™ä½æ°¸æ†ã€‚">æ•æ‰å…‰å½±ï¼Œç•™ä½æ°¸æ†ã€‚</option></optgroup>
                        <optgroup label="--- å‹µå¿—å‰è¡Œ ---"><option value="ä¸å¿˜åˆå¿ƒï¼Œæ–¹å¾—å§‹çµ‚ã€‚">ä¸å¿˜åˆå¿ƒï¼Œæ–¹å¾—å§‹çµ‚ã€‚</option><option value="è¿½é€å¤¢æƒ³ï¼Œæ°¸ä¸æ”¾æ£„ã€‚">è¿½é€å¤¢æƒ³ï¼Œæ°¸ä¸æ”¾æ£„ã€‚</option></optgroup>
                    </select>
                </div>

                <textarea id="text-main" rows="2" placeholder="åœ¨æ­¤è¼¸å…¥é¡Œå­—å…§å®¹..." class="detail-textarea" oninput="updatePreview()"></textarea>
                
                <div class="select-group" style="margin-bottom: 10px;">
                    <span class="select-label">ğŸ”  æ–‡å­—å¤§å°</span>
                    <div class="slider-container">
                        <input type="range" id="text-size" min="10" max="100" value="30" oninput="updatePreview()">
                        <span id="text-size-display">30</span>
                    </div>
                </div>

                <div class="select-grid">
                    <div class="select-group"><span class="select-label">ğŸ…°ï¸ æ–‡å­—é¢¨æ ¼</span><select id="text-style" class="detail-select" onchange="updatePreview()"><option value="none">(ä¸åŠ æ–‡å­—)</option><option value="calligraphy">1. å¤å…¸æ›¸æ³•</option><option value="neon">2. è³½åšéœ“è™¹</option><option value="comic">3. ç†±è¡€æ¼«ç•«</option><option value="cute">4. å¯æ„›æ‰‹å¯«</option><option value="elegant">5. å„ªé›…é‡‘æ¼†</option><option value="typewriter">6. å¾©å¤æ‰“å­—æ©Ÿ</option><option value="graffiti">7. è¡—é ­å¡—é´‰</option><option value="headline">8. æ–°èæ¨™é¡Œ</option><option value="stone">9. æµ®é›•çŸ³åˆ»</option><option value="ink">10. æ°´å¢¨æšˆæŸ“</option></select></div>
                    <div class="select-group"><span class="select-label">â†•ï¸ æ–‡å­—ä½ç½®</span><select id="text-position" class="detail-select"><option value="bottom">ç½®åº• (é è¨­)</option><option value="top">ç½®é ‚</option><option value="center">æ­£ä¸­é–“</option></select></div>
                </div>

                <div style="border-top: 1px solid #444; padding-top: 15px; margin-top: 15px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 20px; margin-right: 5px;">ğŸˆ´</span>
                        <input type="text" id="text-signature" placeholder="è½æ¬¾å¤§å" class="detail-input" style="margin-bottom: 0; border-color: var(--text-accent); color: var(--text-accent); font-weight: bold;" oninput="updatePreview()">
                    </div>
                    <div class="select-grid">
                        <div class="select-group"><span class="select-label">ğŸ”´ å°ç« å½¢ç‹€</span><select id="seal-shape" class="detail-select" onchange="updatePreview()"><option value="square">1. æ­£æ–¹å°</option><option value="rect">2. é•·æ–¹å°</option><option value="circle">3. åœ“å½¢å°</option><option value="oval">4. æ©¢åœ“å°</option><option value="rounded">5. åœ“è§’å°</option></select></div>
                        <div class="select-group"><span class="select-label">âœ’ï¸ å°ç« å­—é«” (æ“¬çœŸ)</span><select id="seal-font" class="detail-select" onchange="updatePreview()"><option value="standard">1. æ¨™æº–æ­£æ¥· (æ¸…æ™°)</option><option value="serif_bold">2. èŠé‡å®‹é«” (å…¸é›…)</option><option value="cursive">3. é£„é€¸è¡Œæ›¸ (æµæš¢)</option><option value="xingcao" selected>4. ç‹‚æ”¾è¡Œè‰ (è—è¡“)</option><option value="heavy">5. åšé‡é»‘é«” (æœ‰åŠ›)</option><option value="old">6. ä»¿å¤éš¸æ›¸ (å¤æ¨¸)</option><option value="seal_script">7. æ¨¡æ“¬ç¯†åˆ» (å‚³çµ±)</option><option value="rough">8. æ–‘é§å¤å° (èˆŠåŒ–)</option><option value="ink_bleed">9. å¢¨æšˆæ‰‹å¯« (æ¸²æŸ“)</option><option value="modern">10. ç¾ä»£ç´°é«” (ç°¡ç´„)</option></select></div>
                    </div>
                </div>

                <div class="select-group" style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                    <span class="select-label">ğŸ–¼ï¸ V22 åšç‰©é¤¨ç´šé‚Šæ¡†</span>
                    <select id="frame-style" class="detail-select" style="border-color: var(--accent-color); font-weight: bold; color: var(--accent-color);">
                        <option value="none">(ä¸åŠ é‚Šæ¡†)</option><option value="gold_classic">1. ğŸ‘‘ ç¶“å…¸é‡‘ç®”æ¡†</option><option value="silver_antique">2. ğŸ›ï¸ å¤å…¸éŠ€é›•æ¡†</option><option value="wood_walnut" selected>3. ğŸªµ æ·±èƒ¡æ¡ƒæœ¨</option><option value="wood_oak">4. ğŸŒ¿ æ·ºè‰²æ©¡æœ¨</option><option value="museum_mat">5. ğŸ–¼ï¸ åšç‰©é¤¨è¥¯ç´™</option><option value="gallery_black">6. â¬› æ¥µç°¡é»‘è—å»Š</option><option value="ornate_vintage">7. âšœï¸ æ­å¼ç¹è¤‡</option><option value="modern_metal">8. âš™ï¸ å·¥æ¥­é¢¨é‡‘å±¬</option><option value="rustic">9. ğŸ‚ é„‰æ‘é¢¨èˆŠæœ¨</option><option value="neon_cyber">10. ğŸ† è³½åšéœ“è™¹æ¡†</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="ai-only-section">
            <h3 style="width:100%; font-size:14px; color:#888; margin-bottom:15px; border-top: 1px solid #333; padding-top: 15px;">âœ¨ é¸é … Aï¼šAI é‡ç¹ªé¢¨æ ¼ (é»æ“Šç”Ÿæˆ)</h3>
            <div class="style-grid">
                <div class="style-card style-real" onclick="generateAI('real')">ğŸ“¸ çœŸäººæ“¬çœŸ</div>
                <div class="style-card style-tao" onclick="generateAI('taoist')">ğŸ•Šï¸ ç™½é™½è–æ½”</div>
                <div class="style-card" onclick="generateAI('pixar')">ğŸ§¸ çš®å…‹æ–¯é¢¨</div>
                <div class="style-card" onclick="generateAI('ghibli')">ğŸƒ å‰åœåŠ›é¢¨</div>
                <div class="style-card" onclick="generateAI('cyberpunk')">ğŸŒƒ è³½åšé¾å…‹</div>
                <div class="style-card" onclick="generateAI('oil')">ğŸ¨ æ¢µè°·æ²¹ç•«</div>
                <div class="style-card" onclick="generateAI('comic')">ğŸ’¥ ç¾å¼æ¼«ç•«</div>
                <div class="style-card" onclick="generateAI('ink')">ğŸ–Œï¸ æ±æ–¹æ°´å¢¨</div>
            </div>
        </div>

        <div class="ai-only-section" style="margin-bottom: 20px;">
             <h3 style="width:100%; font-size:14px; color:#888; margin-bottom:10px;">âœ¨ é¸é … Bï¼šä¿ç•™åŸåœ– (åƒ…è£è£±)</h3>
             <button class="btn-action btn-direct-frame" onclick="finishDirectMode()" style="width:100%; max-width:none;">ç›´æ¥è£è£± (ä¸æ”¹è®Šç•«é¢¨)</button>
        </div>

        <button id="btn-upload-finish" class="btn-action" onclick="finishUploadMode()" style="display:none; width:100%; max-width:none; margin-bottom: 20px;">âœ¨ ç¢ºèªè£è£± (ä½¿ç”¨ä¸Šå‚³åœ–)</button>
        <button style="margin-top:5px; background:transparent; border:none; color:#666; font-size:14px;" onclick="location.reload()">â¬…ï¸ è¿”å›é¦–é </button>
    </div>

    <div id="stage-3" class="stage" style="justify-content: center;">
        <h2 id="loading-text" style="color: var(--accent-color); font-size: 22px;">âš¡ è™•ç†ä¸­...</h2>
        <div class="progress-wrapper">
            <span id="progress-percent" class="progress-text">0%</span>
            <div style="width:100%; height:8px; background:#333; border-radius:4px; overflow: hidden;">
                <div id="progress-bar" style="width:0%; height:100%; background: linear-gradient(90deg, var(--accent-color), #fff); transition:width 0.3s;"></div>
            </div>
        </div>
        <p id="prompt-debug" style="color:#888; font-size:12px; margin-top:15px; max-width:80%; text-align:center;">æ­£åœ¨åˆå§‹åŒ–...</p>
    </div>

    <div id="stage-4" class="stage">
        <h2 style="color: var(--accent-color); font-size: 22px;">âœ¨ æ‚¨çš„å‚³ä¸–å¤§ä½œ</h2>
        <div class="viewport-container" style="background: transparent; border: none; min-height: 300px; height: auto; padding: 10px;">
            <div id="result-placeholder" style="display:block; color:#555;">æ­£åœ¨è£è£±...</div>
            <img id="final-result" src="" style="box-shadow: 0 10px 40px rgba(0,0,0,0.7); width: auto; height: auto; max-width: 100%; max-height: 65vh;">
        </div>
        <p style="color: var(--accent-color); font-weight: bold; font-size: 16px; margin-top: 15px;">ğŸ‘‡ é•·æŒ‰åœ–ç‰‡å„²å­˜ ğŸ‘‡</p>
        <div style="font-size: 13px; color: #888; margin-top: 20px; border-top: 1px solid #333; padding-top: 15px; width: 100%; text-align: center;">
            åˆ†äº«é€£çµï¼š
            <div id="qrcode-container" style="margin-top: 10px; background: white; padding: 10px; display: inline-block; border-radius: 12px;"></div>
        </div>
        <button class="btn-action" onclick="location.reload()" style="background: #333; color:white; font-size:15px; margin-top: 30px; max-width:none; border: 1px solid #555; padding: 12px 0;">ğŸ”„ å†ç©ä¸€æ¬¡</button>
    </div>

    <canvas id="canvas-comp"></canvas>
    <canvas id="canvas-resize"></canvas>
    <canvas id="canvas"></canvas>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    const video = document.getElementById('webcam'), previewImg = document.getElementById('preview-img'), finalImg = document.getElementById('final-result'), cameraList = document.getElementById('camera-list'), errorMsg = document.getElementById('error-msg');
    const canvasComp = document.getElementById('canvas-comp'); const canvasResize = document.getElementById('canvas-resize');
    let currentGender = 'girl'; let isUploadMode = false; let loadingTimer;
    let retryCount = 0; const maxRetries = 3;

    function updatePreview() {
        const pCanvas = document.getElementById('text-preview-canvas'); const pCtx = pCanvas.getContext('2d');
        const text = document.getElementById('text-main').value || "æ–‡å­—æ•ˆæœé è¦½";
        const style = document.getElementById('text-style').value; const sizeVal = document.getElementById('text-size').value;
        const signature = document.getElementById('text-signature').value || "è½æ¬¾";
        const sShape = document.getElementById('seal-shape').value; const sFont = document.getElementById('seal-font').value;
        document.getElementById('text-size-display').innerText = sizeVal;
        pCtx.fillStyle = "#222"; pCtx.fillRect(0,0,pCanvas.width, pCanvas.height);
        const fontSize = Math.floor(pCanvas.width * (sizeVal / 1000)) + 15; 
        applyTextStyle(pCtx, style, fontSize); pCtx.textAlign = 'left'; pCtx.textBaseline = 'middle';
        pCtx.fillText(text.split('\n')[0], 20, 50); 
        if (['comic', 'neon', 'stone'].includes(style)) pCtx.strokeText(text.split('\n')[0], 20, 50);
        drawSmartSeal(pCtx, signature, sShape, sFont, 330, 80, 350);
    }

    function fillQuote() { const select = document.getElementById('quote-select'); const textarea = document.getElementById('text-main'); if (select.value) { textarea.value = select.value; updatePreview(); } }

    async function initCameraMode() {
        errorMsg.innerText = "";
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            await listCameras();
            stream.getTracks().forEach(track => track.stop());
            setMode(false);
            document.getElementById('btn-container').style.display = 'none';
            document.getElementById('step-selection').style.display = 'block';
        } catch (err) { console.error(err); errorMsg.innerText = "å•Ÿå‹•å¤±æ•—ï¼šè«‹ç¢ºèªç€è¦½å™¨å·²å…è¨±ç›¸æ©Ÿæ¬Šé™(NotAllowedError)ã€‚"; }
    }

    async function listCameras() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        cameraList.innerHTML = '';
        videoDevices.forEach((device, index) => {
            const option = document.createElement('option'); option.value = device.deviceId;
            let label = device.label || `ç›¸æ©Ÿ ${index + 1}`;
            if (label.toLowerCase().includes('back') || label.includes('å¾Œ')) label = "ğŸ“¸ å¾Œç½®é¡é ­"; else if (label.toLowerCase().includes('front') || label.includes('å‰')) label = "ğŸ‘¤ å‰ç½®è‡ªæ‹";
            option.text = label; cameraList.appendChild(option);
        });
    }

    async function confirmCamera() {
        const deviceId = cameraList.value;
        const constraints = { video: { deviceId: { exact: deviceId }, width: { ideal: 1920 }, height: { ideal: 1080 } } };
        try { const stream = await navigator.mediaDevices.getUserMedia(constraints); video.srcObject = stream; document.getElementById('start-overlay').style.display = 'none'; switchStage('stage-1'); } catch (err) { 
            try { const stream = await navigator.mediaDevices.getUserMedia({ video: true }); video.srcObject = stream; document.getElementById('start-overlay').style.display = 'none'; switchStage('stage-1'); } catch (fatalErr) { alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®šã€‚"); } 
        }
    }

    const optionsData = { girl: { clothes: [{val:"", txt:"(é è¨­)"}, {val:"wearing white hanfu", txt:"æ¼¢æœ/å¤è£"}, {val:"wearing princess dress", txt:"å¤¢å¹»å…¬ä¸»è£™"}, {val:"wearing qipao dress", txt:"æ——è¢"}, {val:"wearing school uniform", txt:"æ°´æ‰‹æœ/åˆ¶æœ"}, {val:"wearing business suit", txt:"è¥¿è£/å¥—è£"}, {val:"wearing casual t-shirt", txt:"ä¼‘é–’ Tæ¤"}, {val:"wearing cyberpunk armor", txt:"ç§‘æŠ€æˆ°ç”²"}, {val:"wearing witch robe", txt:"å¥³å·«è¢"}, {val:"wearing yoga outfit", txt:"ç‘œçˆæœ"}], hair: [{val:"", txt:"(é è¨­)"}, {val:"long curly hair", txt:"é•·æ²é«®"}, {val:"short bob hair", txt:"ä¿éº—çŸ­é«®"}, {val:"ponytail", txt:"é¦¬å°¾"}, {val:"straight long hair", txt:"é»‘é•·ç›´"}, {val:"twin tails", txt:"é›™é¦¬å°¾"}, {val:"braided hair", txt:"éº»èŠ±è¾®"}, {val:"hair bun", txt:"åŒ…åŒ…é ­"}, {val:"hime cut", txt:"å…¬ä¸»åˆ‡"}], headwear: [{val:"", txt:"(ç„¡)"}, {val:"wearing glasses", txt:"çœ¼é¡"}, {val:"wearing a flower hairpin", txt:"èŠ±æœµé«®ç°ª"}, {val:"wearing a crown", txt:"çš‡å† "}, {val:"wearing cat ears", txt:"è²“è€³"}, {val:"wearing a beret", txt:"ç•«å®¶å¸½"}, {val:"wearing a veil", txt:"é ­ç´—"}, {val:"wearing headphones", txt:"è€³æ©Ÿ"}, {val:"wearing a halo", txt:"å¤©ä½¿å…‰ç’°"}], held: [{val:"", txt:"(ç„¡)"}, {val:"holding a book", txt:"æ‹¿è‘—æ›¸"}, {val:"holding a lotus flower", txt:"æ‹¿è‘—è“®èŠ±"}, {val:"holding a magic wand", txt:"é­”æ³•æ£’"}, {val:"holding bubble tea", txt:"çç å¥¶èŒ¶"}, {val:"holding a camera", txt:"æ‹¿è‘—ç›¸æ©Ÿ"}, {val:"holding a fan", txt:"æ‹¿è‘—æ‰‡å­"}, {val:"holding a guitar", txt:"æŠ±è‘—å‰ä»–"}, {val:"holding a bouquet", txt:"æ§è‘—èŠ±æŸ"}] }, boy: { clothes: [{val:"", txt:"(é è¨­)"}, {val:"wearing white hanfu", txt:"æ¼¢æœ/å¤è£"}, {val:"wearing business suit", txt:"è¥¿è£/æ­£è£"}, {val:"wearing doctor coat", txt:"é†«å¸«è¢"}, {val:"wearing leather jacket", txt:"å¸¥æ°£çš®è¡£"}, {val:"wearing basketball jersey", txt:"ç±ƒçƒè¡£"}, {val:"wearing casual hoodie", txt:"é€£å¸½è¡«"}, {val:"wearing cyberpunk armor", txt:"ç§‘æŠ€æˆ°ç”²"}, {val:"wearing tactical vest", txt:"æˆ°è¡“èƒŒå¿ƒ"}, {val:"wearing tuxedo", txt:"ç‡•å°¾æœ"}], hair: [{val:"", txt:"(é è¨­)"}, {val:"short hair", txt:"ä¿è½çŸ­é«®"}, {val:"middle part hair", txt:"éŸ“ç³»ä¸­åˆ†"}, {val:"slicked back hair", txt:"æ²¹é ­"}, {val:"buzz cut", txt:"å¹³é ­/å…‰é ­"}, {val:"spikey hair", txt:"åˆºèŸé ­"}, {val:"long hair", txt:"è—è¡“é•·é«®"}, {val:"dreadlocks", txt:"é›·é¬¼é«’è¾®"}, {val:"undercut", txt:"å…©å´æ¨é«˜"}], headwear: [{val:"", txt:"(ç„¡)"}, {val:"wearing glasses", txt:"çœ¼é¡"}, {val:"wearing a baseball cap", txt:"æ£’çƒå¸½"}, {val:"wearing a fedora", txt:"ç´³å£«å¸½"}, {val:"wearing a bandana", txt:"é ­å·¾"}, {val:"wearing headphones", txt:"è€³æ©Ÿ"}, {val:"wearing vr goggles", txt:"VRçœ¼é¡"}, {val:"wearing a halo", txt:"å¤©ä½¿å…‰ç’°"}, {val:"wearing a crown", txt:"åœ‹ç‹çš‡å† "}], held: [{val:"", txt:"(ç„¡)"}, {val:"holding a book", txt:"æ‹¿è‘—æ›¸"}, {val:"holding a sword", txt:"æ‹¿è‘—åŠ"}, {val:"holding a guitar", txt:"æŠ±è‘—å‰ä»–"}, {val:"holding a camera", txt:"æ‹¿è‘—ç›¸æ©Ÿ"}, {val:"holding a basketball", txt:"æ‹¿è‘—ç±ƒçƒ"}, {val:"holding a coffee cup", txt:"æ‹¿è‘—å’–å•¡"}, {val:"holding a laptop", txt:"æ‹¿è‘—ç­†é›»"}, {val:"holding a microphone", txt:"æ‹¿è‘—éº¥å…‹é¢¨"}] } };
    function updateOptions(gender) { const data = optionsData[gender]; const populate = (id, items) => { const select = document.getElementById(id); select.innerHTML = ""; items.forEach(item => { const opt = document.createElement("option"); opt.value = item.val; opt.innerText = item.txt; select.appendChild(opt); }); }; populate('opt-clothes', data.clothes); populate('opt-hair', data.hair); populate('opt-headwear', data.headwear); populate('opt-held', data.held); }
    function switchGender(g) { currentGender = g; document.getElementById('btn-boy').classList.toggle('selected', g==='boy'); document.getElementById('btn-girl').classList.toggle('selected', g==='girl'); updateOptions(g); }
    window.onload = () => { updateOptions('girl'); updatePreview(); };

    function setMode(upload) { 
        isUploadMode = upload; 
        const stage2 = document.getElementById('stage-2'); 
        const uploadBtn = document.getElementById('btn-upload-finish'); 
        previewImg.style.display = 'none';
        document.getElementById('preview-placeholder').style.display = 'flex';
        if (isUploadMode) { stage2.classList.add('upload-mode'); uploadBtn.style.display = 'flex'; previewImg.classList.remove('mirror'); } else { stage2.classList.remove('upload-mode'); uploadBtn.style.display = 'none'; previewImg.classList.add('mirror'); } 
    }
    function triggerUpload() { document.getElementById('file-input').click(); }
    document.getElementById('file-input').addEventListener('change', function(e) { if (e.target.files && e.target.files[0]) { const reader = new FileReader(); reader.onload = function(event) { const img = new Image(); img.onload = function() { processInputImage(img); }; img.src = event.target.result; }; reader.readAsDataURL(e.target.files[0]); } });
    
    function finishUploadMode() { composeFinalImage(previewImg.src, "âš¡ æ­£åœ¨ç‚ºæ‚¨çš„ç…§ç‰‡è£è£±..."); }
    function finishDirectMode() { composeFinalImage(previewImg.src, "âš¡ æ­£åœ¨ç‚ºç…§ç‰‡è£è£± (åŸåœ–)..."); }

    function processInputImage(imgElement, isCamera = false) {
        const MAX_WORK_SIZE = 1200; 
        let w = imgElement.width; let h = imgElement.height;
        if (w > h) { if (w > MAX_WORK_SIZE) { h *= MAX_WORK_SIZE / w; w = MAX_WORK_SIZE; } } 
        else { if (h > MAX_WORK_SIZE) { w *= MAX_WORK_SIZE / h; h = MAX_WORK_SIZE; } }
        canvasResize.width = w; canvasResize.height = h;
        const ctx = canvasResize.getContext('2d');
        if (isCamera) { ctx.translate(w, 0); ctx.scale(-1, 1); }
        ctx.drawImage(imgElement, 0, 0, w, h);
        previewImg.src = canvasResize.toDataURL('image/jpeg', 0.95);
        previewImg.style.display = 'block';
        document.getElementById('preview-placeholder').style.display = 'none';
        setMode(!isCamera); document.getElementById('start-overlay').style.display = 'none'; switchStage('stage-2');
    }

    function capturePhoto() { processInputImage(video, true); }

    function getDetails() { const ids = ['opt-clothes', 'opt-hair', 'opt-headwear', 'opt-held', 'opt-location', 'opt-weather']; let details = []; ids.forEach(id => { const val = document.getElementById(id).value; if(val) details.push(val); }); return details.join(", "); }
    
    function generateAI(styleKey) { 
        if (isUploadMode) return; 
        switchStage('stage-3');
        document.getElementById('loading-text').innerText = "âš¡ AI ç¹ªåœ–ä¸­...";
        simulateProgress();
        retryCount = 0;
        tryLoadAI(styleKey, 768, 1024);
    }

    function tryLoadAI(styleKey, width, height) {
        let genderBase = currentGender === 'boy' ? "handsome man, male" : "beautiful woman, female"; 
        let detailPrompt = getDetails(); let fullPrompt = ""; 
        if(styleKey === 'pixar') fullPrompt = `cute 3d pixar style ${genderBase}, ${detailPrompt}, studio lighting, big eyes, 8k`; else if(styleKey === 'ghibli') fullPrompt = `studio ghibli anime portrait of ${genderBase}, ${detailPrompt}, hayao miyazaki style, watercolor background`; else if(styleKey === 'cyberpunk') fullPrompt = `cyberpunk portrait of ${genderBase}, ${detailPrompt}, neon lights, mechanical parts, futuristic city`; else if(styleKey === 'oil') fullPrompt = `van gogh oil painting portrait of ${genderBase}, ${detailPrompt}, thick brushstrokes, artistic, starry night`; else if(styleKey === 'comic') fullPrompt = `american comic superhero ${genderBase}, ${detailPrompt}, bold lines, halftone dots, marvel style`; else if(styleKey === 'ink') fullPrompt = `chinese ink wash painting portrait of ${genderBase}, ${detailPrompt}, black and white, sumi-e, artistic, red stamp`; else if(styleKey === 'real') fullPrompt = `(masterpiece), best quality, realistic photo of a ${genderBase}, ${detailPrompt}, highly detailed face, dslr, 8k, raw photo, soft lighting, looking at camera`; else if(styleKey === 'taoist') fullPrompt = `(masterpiece), traditional chinese ancient style portrait of ${genderBase}, ${detailPrompt}, righteous aura, ethereal atmosphere, soft lighting, hd, 8k`; 
        
        const ratio = previewImg.naturalWidth / previewImg.naturalHeight;
        let aiW = width, aiH = height;
        if (ratio > 1.1) { [aiW, aiH] = [height, width]; } 

        const aiUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(fullPrompt)}?width=${aiW}&height=${aiH}&seed=${Math.floor(Math.random()*999999)}&nologo=true&t=${Date.now()}`; 
        
        const tempImg = new Image();
        tempImg.crossOrigin = "anonymous";
        
        const watchdog = setTimeout(() => { 
            handleAILoadError(styleKey, "è¶…æ™‚");
        }, 60000);

        tempImg.onload = () => {
            clearTimeout(watchdog);
            composeFinalImage(aiUrl, "âš¡ AI ç¹ªåœ–èˆ‡è£è£±ä¸­...");
        };

        tempImg.onerror = () => {
            clearTimeout(watchdog);
            handleAILoadError(styleKey, "è¼‰å…¥å¤±æ•—");
        };

        tempImg.src = aiUrl;
    }

    function handleAILoadError(styleKey, reason) {
        retryCount++;
        const debug = document.getElementById('prompt-debug');
        
        if (retryCount === 1) {
            debug.innerText = `é€£ç·šç¹å¿™ï¼Œé™ç´šé‡è©¦ä¸­ (1/3)...`;
            setTimeout(() => { tryLoadAI(styleKey, 512, 768); }, 1000);
        } else if (retryCount === 2) {
            debug.innerText = `ä¼ºæœå™¨æ“å¡ï¼Œæ¥µé€Ÿæ¨¡å¼é‡è©¦ (2/3)...`;
            setTimeout(() => { tryLoadAI(styleKey, 384, 512); }, 1000);
        } else {
            // V33: éœé»˜æ•‘æ´ (Silent Failover) - ä¸å†å ±éŒ¯ï¼Œç›´æ¥ç”¨åŸåœ–
            debug.innerText = "AI å¿™ç·šï¼Œå·²åˆ‡æ›è‡³åŸåœ–è£è£±...";
            console.log("AI Failover Triggered");
            setTimeout(() => {
                // ä½¿ç”¨é è¦½åœ– (base64) é€²è¡Œè£è£±
                composeFinalImage(previewImg.src, "âš ï¸ AI å¿™ç·šï¼Œå·²ç‚ºæ‚¨è£è£±åŸåœ–");
            }, 1000);
        }
    }

    function composeFinalImage(sourceImageUrl, loadingMsg) {
        document.getElementById('loading-text').innerText = loadingMsg || "âš¡ è™•ç†ä¸­..."; 
        document.getElementById('prompt-debug').innerText = "å½±åƒåˆæˆä¸­...";

        const rawText = document.getElementById('text-main').value; const textStyle = document.getElementById('text-style').value; const signature = document.getElementById('text-signature').value; const position = document.getElementById('text-position').value; const frameStyle = document.getElementById('frame-style').value; const textSizeVal = document.getElementById('text-size').value; const sealShape = document.getElementById('seal-shape').value; const sealFont = document.getElementById('seal-font').value;
        
        const baseImg = new Image();
        // V33: åƒ…å° http åœ–ç‰‡è·¨åŸŸï¼Œdata: åœ–ç‰‡ (æ•‘æ´/ä¸Šå‚³) ä¸è·¨åŸŸ
        if (sourceImageUrl.startsWith('http')) { baseImg.crossOrigin = "anonymous"; }
        
        // V33: æœ€çµ‚åˆæˆéšæ®µçš„éŒ¯èª¤è™•ç† - è‹¥ AI åœ–å†æ¬¡å¤±æ•—ï¼Œå¼·åˆ¶ä½¿ç”¨æœ¬åœ°åœ–
        baseImg.onerror = () => { 
            if (sourceImageUrl.startsWith('http')) {
                 console.log("Canvas load error, forcing local fallback.");
                 composeFinalImage(previewImg.src, "âš ï¸ å½±åƒè™•ç†ç•°å¸¸ï¼Œä½¿ç”¨åŸåœ–å‚™ä»½");
            } else {
                 alert("å½±åƒè™•ç†åš´é‡éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†ã€‚"); location.reload(); 
            }
        };

        baseImg.onload = () => {
            const MAX_FINAL_DIM = 1200; 
            let workW = baseImg.width; let workH = baseImg.height;
            if (workW > workH) { if (workW > MAX_FINAL_DIM) { workH *= MAX_FINAL_DIM/workW; workW = MAX_FINAL_DIM; } }
            else { if (workH > MAX_FINAL_DIM) { workW *= MAX_FINAL_DIM/workH; workH = MAX_FINAL_DIM; } }
            
            const baseDim = Math.min(workW, workH);
            let frameThickness = 0; let matThickness = 0;
            if (frameStyle !== 'none') { if(frameStyle.includes('gold') || frameStyle.includes('vintage') || frameStyle.includes('walnut')) frameThickness = baseDim * 0.06; else frameThickness = baseDim * 0.04; if (frameStyle === 'museum_mat') matThickness = baseDim * 0.12; else if (frameStyle === 'gold_classic' || frameStyle === 'silver_antique') matThickness = baseDim * 0.025; }
            const ft = Math.floor(frameThickness); const mt = Math.floor(matThickness); const totalBorder = ft + mt;
            
            canvasComp.width = workW + (totalBorder * 2); canvasComp.height = workH + (totalBorder * 2);
            const ctx = canvasComp.getContext('2d'); const cw = canvasComp.width; const ch = canvasComp.height;
            const contentX = totalBorder; const contentY = totalBorder; const contentW = workW; const contentH = workH;

            if (frameStyle !== 'none') { applyAdvancedFrame(ctx, frameStyle, cw, ch, ft, mt); }
            ctx.drawImage(baseImg, 0, 0, baseImg.width, baseImg.height, contentX, contentY, contentW, contentH);
            
            if (frameStyle !== 'none' && frameStyle !== 'neon_cyber') { ctx.shadowColor = "rgba(0,0,0,0.75)"; ctx.shadowBlur = ft*0.8; ctx.shadowOffsetX = ft*0.2; ctx.shadowOffsetY = ft*0.2; ctx.strokeStyle = "rgba(0,0,0,0.2)"; ctx.lineWidth = 2; ctx.strokeRect(contentX, contentY, contentW, contentH); ctx.shadowBlur = 0; }
            
            ctx.save(); ctx.beginPath(); ctx.rect(contentX, contentY, contentW, contentH); ctx.clip();
            if (rawText && textStyle !== 'none') {
                const lines = rawText.split('\n'); const fontSize = Math.floor(contentW * (textSizeVal / 500)); applyTextStyle(ctx, textStyle, fontSize); ctx.textAlign = 'center'; const lineHeight = fontSize * 1.3; let startY;
                if (position === 'top') startY = contentY + fontSize * 2; else if (position === 'center') startY = contentY + (contentH / 2) - ((lines.length * lineHeight) / 2); else startY = contentY + contentH - (lines.length * lineHeight) - (fontSize * 0.8);
                lines.forEach((line, i) => { let y = startY + (i * lineHeight); ctx.fillText(line, contentX + contentW / 2, y); if (['comic', 'neon', 'stone'].includes(textStyle)) { ctx.strokeText(line, contentX + contentW / 2, y); } });
            }
            if (signature) { drawSmartSeal(ctx, signature, sealShape, sealFont, contentX + contentW, contentY + contentH, contentW); }
            ctx.restore();

            finalImg.src = canvasComp.toDataURL('image/png'); 
            finalImg.style.display = 'block';
            document.getElementById('result-placeholder').style.display = 'none';
            
            document.getElementById("qrcode-container").innerHTML = ""; new QRCode(document.getElementById("qrcode-container"), { text: window.location.href, width: 120, height: 120 }); switchStage('stage-4');
        };
        baseImg.src = sourceImageUrl;
    }

    function applyAdvancedFrame(ctx, style, w, h, ft, mt) { const total = ft + mt; if (mt > 0) { ctx.fillStyle = '#fdfdfd'; ctx.fillRect(0, 0, w, h); drawNoise(ctx, 0, 0, w, h, 0.04); drawSolidBevel(ctx, ft, ft, w-ft*2, h-ft*2, Math.max(2, mt*0.1), '#ffffff', '#d9d9d9'); } if (ft > 0) { ctx.save(); ctx.beginPath(); ctx.rect(0, 0, w, h); ctx.rect(total, total, w - total*2, h - total*2); ctx.clip('evenodd'); if (style === 'gold_classic') { let grad = ctx.createLinearGradient(0, 0, w, h); grad.addColorStop(0, '#e6c26e'); grad.addColorStop(0.3, '#bf953f'); grad.addColorStop(0.5, '#fcf6ba'); grad.addColorStop(0.7, '#b38728'); grad.addColorStop(1, '#aa771c'); ctx.fillStyle = grad; ctx.fillRect(0,0,w,h); drawNoise(ctx, 0,0,w,h, 0.06); drawDeepBevel(ctx, 0, 0, w, h, ft, 'rgba(255,255,255,0.7)', 'rgba(80,60,20,0.7)'); } else if (style === 'wood_walnut') { ctx.fillStyle = '#4a332a'; ctx.fillRect(0,0,w,h); drawWoodTexture(ctx, w, h, '#2e1e19', 0.4); drawDeepBevel(ctx, 0, 0, w, h, ft, 'rgba(255,255,255,0.15)', 'rgba(0,0,0,0.6)'); } else if (style === 'ornate_vintage') { ctx.fillStyle = '#3d2b1f'; ctx.fillRect(0,0,w,h); drawWoodTexture(ctx, w, h, '#221100', 0.3); ctx.shadowColor="rgba(0,0,0,0.8)"; ctx.shadowBlur=ft*0.3; ctx.strokeStyle = '#d4af37'; ctx.lineWidth = ft * 0.15; ctx.strokeRect(ft*0.3, ft*0.3, w-ft*0.6, h-ft*0.6); ctx.shadowBlur=0; drawDeepBevel(ctx, 0, 0, w, h, ft, 'rgba(255,240,200,0.25)', 'rgba(0,0,0,0.85)'); } else if (style === 'neon_cyber') { ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0,0,w,h); ctx.shadowColor = '#00eaff'; ctx.shadowBlur = ft; ctx.strokeStyle = '#ff00de'; ctx.lineWidth = ft*0.1; ctx.strokeRect(ft, ft, w - ft*2, h - ft*2); ctx.shadowBlur = 0; } else if (style === 'gallery_black') { ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0,0,w,h); drawNoise(ctx,0,0,w,h,0.03); drawDeepBevel(ctx, 0, 0, w, h, ft, 'rgba(255,255,255,0.2)', 'rgba(0,0,0,0.8)'); } else { ctx.fillStyle = '#e0e0e0'; ctx.fillRect(0,0,w,h); drawNoise(ctx,0,0,w,h,0.05); drawDeepBevel(ctx, 0, 0, w, h, ft, 'rgba(255,255,255,0.4)', 'rgba(0,0,0,0.5)'); } ctx.restore(); } }
    function drawSmartSeal(ctx, name, shape, fontStyle, rightX, bottomY, canvasW) { const baseSize = Math.floor(canvasW * 0.12); const margin = baseSize * 0.3; const x = rightX - baseSize - margin; const y = bottomY - baseSize - margin; const center = baseSize / 2; ctx.save(); ctx.translate(x, y); ctx.shadowColor = "#990000"; ctx.shadowBlur = 4; ctx.fillStyle = "#c21f1f"; ctx.beginPath(); if (shape === 'square') ctx.rect(0, 0, baseSize, baseSize); else if (shape === 'rect') ctx.rect(0, baseSize*0.2, baseSize, baseSize*0.6); else if (shape === 'circle') ctx.arc(center, center, center, 0, Math.PI*2); else if (shape === 'oval') ctx.ellipse(center, center, center, center*0.6, 0, 0, Math.PI*2); else if (shape === 'rounded') { const r = baseSize*0.2; ctx.roundRect(0,0,baseSize,baseSize,r); } ctx.fill(); ctx.shadowBlur = 0; drawNoise(ctx, 0, 0, baseSize, baseSize, 0.15); 
        let fontName = "sans-serif"; let fontWeight = "bold"; let fontStyleCSS = "normal";
        switch(fontStyle) { 
            case 'standard': fontName = '"Microsoft JhengHei", "Heiti TC", sans-serif'; break; 
            case 'serif_bold': fontName = '"Songti SC", "STSong", "serif"'; fontWeight="900"; break; 
            case 'cursive': fontName = '"Kaiti SC", "STKaiti", "KaiTi", cursive'; fontWeight="normal"; break;
            case 'xingcao': fontName = '"Kaiti SC", "STKaiti", "KaiTi", cursive'; fontWeight="normal"; fontStyleCSS="italic"; ctx.shadowColor="rgba(0,0,0,0.3)"; ctx.shadowBlur=2; break; 
            case 'heavy': fontName = '"Arial Black", "Heiti TC", sans-serif'; fontWeight="900"; break; 
            case 'thin': fontName = '"MingLiU", "PMingLiU", serif'; fontWeight="100"; break; 
            case 'old': fontName = '"LiSu", "Kaiti SC", serif'; break; 
            case 'seal_script': fontName = '"SimSun", "Songti SC", serif'; break; 
            case 'rough': fontName = '"Courier New", monospace'; break; 
            case 'ink_bleed': fontName = '"Kaiti SC", "STKaiti", serif'; ctx.shadowColor="#c21f1f"; ctx.shadowBlur=5; break; 
            case 'modern': fontName = 'Arial, sans-serif'; fontWeight="100"; break; 
        } 
        ctx.fillStyle = "#fdfdfd"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; let fontSize = baseSize * 0.8; 
        ctx.font = `${fontStyleCSS} ${fontWeight} ${fontSize}px ${fontName}`; 
        if (name.length <= 2 || shape === 'rect' || shape === 'oval') { const maxWidth = (shape === 'rect' || shape === 'oval') ? baseSize * 0.9 : baseSize * 0.8; while (ctx.measureText(name).width > maxWidth && fontSize > 10) { fontSize -= 2; ctx.font = `${fontStyleCSS} ${fontWeight} ${fontSize}px ${fontName}`; } ctx.fillText(name, center, center); } 
        else { fontSize = baseSize * 0.4; ctx.font = `${fontStyleCSS} ${fontWeight} ${fontSize}px ${fontName}`; const mid = Math.ceil(name.length / 2); const line1 = name.substring(0, mid); const line2 = name.substring(mid); const maxLineW = baseSize * 0.75; while ((ctx.measureText(line1).width > maxLineW || ctx.measureText(line2).width > maxLineW) && fontSize > 8) { fontSize -= 2; ctx.font = `${fontStyleCSS} ${fontWeight} ${fontSize}px ${fontName}`; } ctx.fillText(line1, center + fontSize*0.1, center - fontSize*0.55); ctx.fillText(line2, center - fontSize*0.1, center + fontSize*0.55); } ctx.restore(); }
    function drawDeepBevel(ctx,x,y,w,h,t,lc,sc){ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+w,y);ctx.lineTo(x+w-t,y+t);ctx.lineTo(x+t,y+t);ctx.fillStyle=lc;ctx.fill();ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+t,y+t);ctx.lineTo(x+t,y+h-t);ctx.lineTo(x,y+h);ctx.fillStyle=lc;ctx.fill();ctx.beginPath();ctx.moveTo(x+w,y);ctx.lineTo(x+w,y+h);ctx.lineTo(x+w-t,y+h-t);ctx.lineTo(x+w-t,y+t);ctx.fillStyle=sc;ctx.fill();ctx.beginPath();ctx.moveTo(x,y+h);ctx.lineTo(x+t,y+h-t);ctx.lineTo(x+w-t,y+h-t);ctx.lineTo(x+w,y+h);ctx.fillStyle=sc;ctx.fill();}
    function drawSolidBevel(ctx,x,y,w,h,t,c1,c2){ctx.fillStyle=c1;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+w,y);ctx.lineTo(x+w-t,y+t);ctx.lineTo(x+t,y+t);ctx.fill();ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+t,y+t);ctx.lineTo(x+t,y+h-t);ctx.lineTo(x,y+h);ctx.fill();ctx.fillStyle=c2;ctx.beginPath();ctx.moveTo(x+w,y);ctx.lineTo(x+w,y+h);ctx.lineTo(x+w-t,y+h-t);ctx.lineTo(x+w-t,y+t);ctx.fill();ctx.beginPath();ctx.moveTo(x,y+h);ctx.lineTo(x+t,y+h-t);ctx.lineTo(x+w-t,y+h-t);ctx.lineTo(x+w,y+h);ctx.fill();}
    function drawNoise(ctx,x,y,w,h,a){const id=ctx.getImageData(x,y,w,h);for(let i=0;i<id.data.length;i+=4){const n=(Math.random()-0.5)*255*a;id.data[i]+=n;id.data[i+1]+=n;id.data[i+2]+=n;}ctx.putImageData(id,x,y);}
    function drawWoodTexture(ctx,w,h,c,a){ctx.save();ctx.strokeStyle=c;ctx.lineWidth=1.5;ctx.globalAlpha=a;for(let i=0;i<w;i+=3+Math.random()*5){ctx.beginPath();ctx.moveTo(i,0);for(let j=0;j<h;j+=20){ctx.lineTo(i+Math.sin(j*0.02+i)*8+(Math.random()-0.5)*3,j);}ctx.stroke();}ctx.restore();}
    function applyTextStyle(ctx,s,fs){ctx.font=`bold ${fs}px "Microsoft JhengHei",sans-serif`;ctx.lineWidth=fs/12;ctx.shadowBlur=0;ctx.shadowColor='transparent';switch(s){case 'calligraphy':ctx.fillStyle='white';ctx.font=`bold ${fs*1.1}px "Kaiti SC",STKaiti,serif`;ctx.shadowColor="rgba(0,0,0,0.8)";ctx.shadowBlur=8;break;case 'neon':ctx.fillStyle='#00eaff';ctx.strokeStyle='#ff00de';ctx.shadowColor='#00eaff';ctx.shadowBlur=15;ctx.lineWidth=3;break;case 'comic':ctx.fillStyle='#ffd700';ctx.strokeStyle='black';ctx.lineWidth=6;ctx.font=`900 ${fs}px "Arial Black",sans-serif`;break;case 'cute':ctx.fillStyle='#ff99cc';ctx.font=`bold ${fs}px "Comic Sans MS",cursive`;ctx.shadowColor="white";ctx.shadowBlur=4;break;case 'elegant':ctx.fillStyle='#d4af37';ctx.font=`italic bold ${fs}px serif`;ctx.shadowColor="#222";ctx.shadowBlur=4;break;case 'typewriter':ctx.fillStyle='#00ff00';ctx.font=`${fs}px monospace`;ctx.shadowColor="black";ctx.shadowBlur=2;break;case 'graffiti':ctx.fillStyle='white';ctx.strokeStyle='#ff3300';ctx.lineWidth=4;ctx.font=`900 ${fs*1.1}px sans-serif`;break;case 'headline':ctx.fillStyle='white';ctx.strokeStyle='black';ctx.lineWidth=3;ctx.font=`900 ${fs}px impact,sans-serif`;break;case 'stone':ctx.fillStyle='#888';ctx.strokeStyle='#333';ctx.lineWidth=2;ctx.shadowColor="black";ctx.shadowBlur=2;ctx.shadowOffsetX=2;ctx.shadowOffsetY=2;break;case 'ink':ctx.fillStyle='rgba(0,0,0,0.8)';ctx.font=`bold ${fs}px "Kaiti SC",STKaiti,serif`;ctx.shadowColor="rgba(255,255,255,0.3)";ctx.shadowBlur=4;break;}}

    function simulateProgress() { const bar = document.getElementById('progress-bar'); const text = document.getElementById('progress-percent'); const debug = document.getElementById('prompt-debug'); let w = 0; const int = setInterval(() => { if(w>=99) clearInterval(int); if(w < 50) w += Math.random() * 5; else if(w < 80) w += Math.random() * 2; else w += Math.random() * 0.5; w = Math.min(w, 99); bar.style.width = w + '%'; text.innerText = Math.floor(w) + '%'; if(w < 30) debug.innerText = "æ­£åœ¨æ§‹æ€ç•«é¢ç´°ç¯€..."; else if(w < 60) debug.innerText = "AI å¤§å¸«æ®æ¯«ä¸­..."; else if(w < 90) debug.innerText = "æ­£åœ¨é€²è¡Œå…‰å½±æ¸²æŸ“..."; else debug.innerText = "æœ€å¾Œä¿®é£¾èˆ‡è£è£±..."; }, 500); }
    function switchStage(id) { document.querySelectorAll('.stage').forEach(el => { el.style.display = 'none'; el.classList.remove('active'); }); const target = document.getElementById(id); target.style.display = 'flex'; setTimeout(()=>target.classList.add('active'), 10); }
</script>
</body>
</html>