<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live Mirror AI - V19.0 Stable Fix</title>
    <style>
        /* M28 è¦–è¦ºå‚³æ’­ï¼šé»‘é‡‘è—å»Šé¢¨æ ¼ */
        :root { --bg-color: #000000; --panel-bg: #1a1a1a; --accent-color: #d4af37; --text-accent: #ff3366; --text-primary: #ffffff; }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); color: var(--text-primary); display: flex; justify-content: center; align-items: center; }
        #app-window { width: 100%; height: 100dvh; max-width: 500px; background: var(--panel-bg); display: flex; flex-direction: column; position: relative; overflow: hidden; }
        
        header { padding: 15px; text-align: center; border-bottom: 1px solid #333; font-weight: bold; flex: none; font-size: 18px; display: flex; justify-content: center; align-items: center; gap: 10px; color: var(--accent-color); }
        .version-tag { font-size: 10px; background: var(--accent-color); padding: 2px 6px; border-radius: 4px; color: #000; font-weight: bold; }

        .stage { flex: 1; display: none; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        .active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* V19 ä¿®æ­£: ç§»é™¤å›ºå®š aspect-ratioï¼Œæ”¹ç‚ºè‡ªé©æ‡‰ */
        .viewport { width: 100%; min-height: 300px; background: #000; border: none; overflow: hidden; position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; flex: none; }
        video, img { width: 100%; height: 100%; object-fit: contain; max-height: 60vh; } 
        .mirror { transform: scaleX(-1); }

        .control-panel { width: 100%; background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #444; transition: all 0.3s; }
        .panel-title { font-size: 14px; color: var(--accent-color); margin-bottom: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        
        .ai-only-section { display: block; }
        .upload-mode .ai-only-section { display: none !important; }

        .detail-textarea { width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 8px; font-size: 14px; outline: none; margin-bottom: 10px; resize: none; font-family: inherit; }
        .detail-input { width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 8px; font-size: 14px; outline: none; margin-bottom: 10px; }
        .detail-input:focus, .detail-textarea:focus { border-color: var(--accent-color); }

        .select-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .select-group { display: flex; flex-direction: column; gap: 5px; }
        .select-label { font-size: 11px; color: #888; margin-left: 2px; }
        select.detail-select { width: 100%; padding: 8px; background: #333; color: white; border: 1px solid #555; border-radius: 8px; font-size: 13px; outline: none; appearance: none; transition: border 0.3s; }
        select.detail-select:focus { border-color: var(--accent-color); }

        #start-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        
        .btn-group { display: flex; gap: 15px; width: 100%; justify-content: center; margin-top: 20px; }
        .btn-action { flex: 1; padding: 14px 0; border-radius: 50px; border: none; background: var(--accent-color); color: #000; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 0 15px rgba(212, 175, 55, 0.3); max-width: 180px; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-upload { background: #444; color: white; border: 1px solid #666; box-shadow: none; }
        .btn-upload:hover { background: #555; }

        select.camera-select { width: 100%; padding: 12px; margin-bottom: 15px; background: #333; color: white; border: 1px solid #555; border-radius: 12px; font-size: 16px; outline: none; }
        
        .style-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; padding-bottom: 40px;}
        .style-card { background: #2a2a2a; border: 1px solid #444; border-radius: 12px; padding: 12px 5px; cursor: pointer; text-align: center; font-size: 15px; position: relative; overflow: hidden; transition: all 0.2s; }
        .style-card:active { transform: scale(0.96); background: #444; }
        .style-real { border-color: var(--accent-color); }
        .style-tao { border-color: #ffffff; background: linear-gradient(45deg, #2a2a2a, #555); }

        .gender-toggle { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .gender-option { flex: 1; text-align: center; padding: 10px; background: #333; border-radius: 10px; border: 1px solid #555; cursor: pointer; font-weight: bold; color: #888; font-size: 15px; transition: all 0.3s; }
        .gender-option.selected { background: var(--accent-color); color: #000; }
        
        /* V19 ä¿®æ­£: å¼·åˆ¶éš±è—æ‰€æœ‰ canvasï¼Œé¿å…é‡ç–Š */
        canvas { display: none !important; }
        #file-input { display: none; }
    </style>
</head>
<body>

<div id="app-window">
    <header>
        Live Mirror AI <span class="version-tag">V19.0 ä¿®æ­£ç‰ˆ</span>
    </header>

    <div id="start-overlay">
        <h1 style="color:white; margin-bottom:10px;">ğŸ‘‹ æ­¡è¿é«”é©—</h1>
        <p style="color:#aaa; margin-bottom:20px;">V19.0 ç©©å®šä¿®æ­£ç‰ˆ</p>
        
        <div class="btn-group">
            <button class="btn-action" onclick="firstStartCamera()">ğŸ“¸ å•Ÿå‹•ç›¸æ©Ÿ<br>(AI ç”Ÿæˆ)</button>
            <button class="btn-action btn-upload" onclick="triggerUpload()">ğŸ“ ä¸Šå‚³ç…§ç‰‡<br>(ç´”è£è£±)</button>
        </div>

        <div id="step-selection" style="display:none; width:100%; margin-top: 20px;">
            <p style="color:white; margin-bottom:15px;">å·²åµæ¸¬åˆ°ç›¸æ©Ÿï¼š</p>
            <select id="camera-list" class="camera-select"></select>
            <div style="display:flex; justify-content:center;"><button class="btn-action" onclick="startSpecificCamera()">âœ… ç¢ºèª</button></div>
        </div>
        <p id="error-msg" style="color: #ff3366; font-size: 12px; margin-top: 20px; max-width: 80%;"></p>
    </div>
    
    <input type="file" id="file-input" accept="image/*">

    <div id="stage-1" class="stage">
        <div class="viewport" style="aspect-ratio: 3/4;">
            <video id="webcam" playsinline class="mirror" autoplay></video>
        </div>
        <button class="btn-action" onclick="capturePhoto()">ğŸ“¸ æ‹ç…§</button>
        <p style="margin-top:20px; font-size:14px; color:#666; cursor:pointer; text-decoration: underline;" onclick="location.reload()">[è¿”å›é¦–é ]</p>
    </div>

    <div id="stage-2" class="stage">
        <div class="viewport" style="width: 160px; height: 160px; min-height: auto; border-radius: 12px; border: 2px solid var(--accent-color); margin-top: 5px;">
            <img id="preview-img" src="">
        </div>
        
        <div class="ai-only-section">
            <div class="gender-toggle">
                <div class="gender-option" onclick="switchGender('boy')" id="btn-boy">ğŸ‘¦ ç”·ç”Ÿ</div>
                <div class="gender-option selected" onclick="switchGender('girl')" id="btn-girl">ğŸ‘§ å¥³ç”Ÿ</div>
            </div>

            <div class="control-panel">
                <div class="panel-title">ğŸ¬ å°æ¼”æŒ‡ä»¤ (AIè¨­å®š)</div>
                <div class="select-grid">
                    <div class="select-group"><span class="select-label">ğŸ‘— æœè£</span><select id="opt-clothes" class="detail-select"></select></div>
                    <div class="select-group"><span class="select-label">ğŸ’‡ é«®å‹</span><select id="opt-hair" class="detail-select"></select></div>
                    <div class="select-group"><span class="select-label">ğŸ‘‘ é ­é£¾</span><select id="opt-headwear" class="detail-select"></select></div>
                    <div class="select-group"><span class="select-label">ğŸ¤² æ‰‹æŒç‰©å“</span><select id="opt-held" class="detail-select"></select></div>
                    <div class="select-group"><span class="select-label">ğŸ“ åœ°é»</span><select id="opt-location" class="detail-select">
                        <option value="">(éš¨æ©Ÿ)</option><option value="in a forest">æ£®æ—</option><option value="at the beach">æµ·é‚Š</option><option value="in a cyberpunk city">æœªä¾†åŸå¸‚</option><option value="in an ancient temple">å¤è€å»Ÿå®‡</option><option value="in a classroom">æ•™å®¤</option><option value="in outer space">å¤–å¤ªç©º</option><option value="in a library">åœ–æ›¸é¤¨</option><option value="in a flower field">æµªæ¼«èŠ±æµ·</option><option value="on a snowy mountain">é›ªå±±ä¹‹å·”</option><option value="on a concert stage">æ¼”å”±æœƒèˆå°</option>
                    </select></div>
                    <div class="select-group"><span class="select-label">ğŸŒ¤ï¸ å¤©æ°£/æ°›åœ</span><select id="opt-weather" class="detail-select">
                        <option value="">(éš¨æ©Ÿ)</option><option value="sunny day, bright lighting">é™½å…‰ç‡¦çˆ›</option><option value="raining, cinematic lighting">ä¸‹é›¨é›»å½±æ„Ÿ</option><option value="starry night">æ˜Ÿç©ºå¤œæ™š</option><option value="sunset, golden hour">é»ƒæ˜é‡‘å…‰</option><option value="foggy, mysterious">éœ§æ°£ç¥ç§˜</option><option value="cherry blossoms falling">æ«»èŠ±é›¨</option><option value="northern lights sky">æ¥µå…‰</option><option value="rainbow in sky">å½©è™¹</option><option value="thunderstorm background">é›·é›»äº¤åŠ </option>
                    </select></div>
                </div>
            </div>
        </div>

        <div class="control-panel" style="border-color: var(--text-accent);">
            <div class="panel-title" style="color: var(--text-accent);">âœï¸ åœ–æ–‡é¡Œå­—èˆ‡è£è£±</div>
            <div style="display: flex; flex-direction: column;">
                <textarea id="text-main" rows="2" placeholder="è¼¸å…¥ä½ æƒ³å¯«çš„è©±..." class="detail-textarea"></textarea>
                <div class="select-grid">
                    <div class="select-group"><span class="select-label">ğŸ…°ï¸ æ–‡å­—é¢¨æ ¼</span><select id="text-style" class="detail-select"><option value="none">(ä¸åŠ æ–‡å­—)</option><option value="calligraphy">1. å¤å…¸æ›¸æ³•</option><option value="neon">2. è³½åšéœ“è™¹</option><option value="comic">3. ç†±è¡€æ¼«ç•«</option><option value="cute">4. å¯æ„›æ‰‹å¯«</option><option value="elegant">5. å„ªé›…é‡‘æ¼†</option><option value="typewriter">6. å¾©å¤æ‰“å­—æ©Ÿ</option><option value="graffiti">7. è¡—é ­å¡—é´‰</option><option value="headline">8. æ–°èæ¨™é¡Œ</option><option value="stone">9. æµ®é›•çŸ³åˆ»</option><option value="ink">10. æ°´å¢¨æšˆæŸ“</option></select></div>
                    <div class="select-group"><span class="select-label">â†•ï¸ æ–‡å­—ä½ç½®</span><select id="text-position" class="detail-select"><option value="bottom">ç½®åº• (é è¨­)</option><option value="top">ç½®é ‚</option><option value="center">æ­£ä¸­é–“</option></select></div>
                </div>
                <div style="display: flex; align-items: center; border-top: 1px solid #444; padding-top: 10px; margin-top: 10px;">
                    <span style="font-size: 20px; margin-right: 5px;">ğŸˆ´</span>
                    <input type="text" id="text-signature" placeholder="è¼¸å…¥è½æ¬¾å¤§å (ç´…å°)" class="detail-input" style="margin-bottom: 0; border-color: #ff3333;">
                </div>
                <div class="select-group" style="margin-top: 10px; border-top: 1px solid #444; padding-top: 10px;">
                    <span class="select-label">ğŸ–¼ï¸ è—å»Šé‚Šæ¡† (10ç¨®)</span>
                    <select id="frame-style" class="detail-select" style="border-color: var(--accent-color);">
                        <option value="none">(ä¸åŠ é‚Šæ¡†)</option><option value="gold_classic">1. ç¶“å…¸é‡‘ç®”æ¡†</option><option value="silver_antique">2. å¤å…¸éŠ€é›•æ¡†</option><option value="wood_walnut">3. æ·±è‰²èƒ¡æ¡ƒæœ¨</option><option value="wood_oak">4. æ·ºè‰²æ©¡æœ¨æ¡†</option><option value="museum_mat">5. åšé¤¨ç´šè¥¯ç´™</option><option value="gallery_black">6. æ¥µç°¡é»‘è—å»Š</option><option value="ornate_vintage">7. æ­å¼ç¹è¤‡æ¡†</option><option value="modern_metal">8. å·¥æ¥­é¢¨é‡‘å±¬</option><option value="rustic">9. é„‰æ‘é¢¨èˆŠæœ¨</option><option value="neon_cyber">10. è³½åšéœ“è™¹æ¡†</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="ai-only-section">
            <h3 style="width:100%; font-size:14px; color:#888; margin-bottom:10px;">ç¢ºèª AI ç•«é¢¨ï¼š</h3>
            <div class="style-grid">
                <div class="style-card style-real" onclick="generateAI('real')">ğŸ“¸ çœŸäººæ“¬çœŸ</div>
                <div class="style-card style-tao" onclick="generateAI('taoist')">ğŸ•Šï¸ ç™½é™½è–æ½”</div>
                <div class="style-card" onclick="generateAI('pixar')">ğŸ§¸ çš®å…‹æ–¯é¢¨</div>
                <div class="style-card" onclick="generateAI('ghibli')">ğŸƒ å‰åœåŠ›é¢¨</div>
                <div class="style-card" onclick="generateAI('cyberpunk')">ğŸŒƒ è³½åšé¾å…‹</div>
                <div class="style-card" onclick="generateAI('oil')">ğŸ¨ æ¢µè°·æ²¹ç•«</div>
                <div class="style-card" onclick="generateAI('comic')">ğŸ’¥ ç¾å¼æ¼«ç•«</div>
                <div class="style-card" onclick="generateAI('ink')">ğŸ–Œï¸ æ±æ–¹æ°´å¢¨</div>
            </div>
        </div>

        <button id="btn-upload-finish" class="btn-action" onclick="finishUploadMode()" style="display:none; width:100%; max-width:none; margin-bottom: 20px;">âœ¨ ç¢ºèªè£è£± (è·³éAI)</button>
        
        <button style="margin-top:5px; background:transparent; border:none; color:#666; font-size:15px;" onclick="location.reload()">â¬…ï¸ è¿”å›é¦–é </button>
    </div>

    <div id="stage-3" class="stage" style="justify-content: center;">
        <h2 id="loading-text">âš¡ è™•ç†ä¸­...</h2>
        <div style="width:70%; height:6px; background:#333; margin-top:20px; border-radius:3px;">
            <div id="progress-bar" style="width:0%; height:100%; background:var(--accent-color); transition:width 0.3s;"></div>
        </div>
        <p id="prompt-debug" style="color:#666; font-size:12px; margin-top:15px; max-width:80%; text-align:center;"></p>
    </div>

    <div id="stage-4" class="stage">
        <h2>âœ¨ æ‚¨çš„å…¸è—å¤§ä½œ</h2>
        <div class="viewport" style="background: transparent; box-shadow: none; border: none;">
            <img id="final-result" src="">
        </div>
        <p style="color: var(--accent-color); font-weight: bold; font-size: 18px; margin-top: 5px;">ğŸ‘‡ é•·æŒ‰åœ–ç‰‡å„²å­˜ ğŸ‘‡</p>
        <div style="font-size: 13px; color: #888; margin-top: 20px; border-top: 1px solid #333; padding-top: 15px; width: 100%; text-align: center;">
            åˆ†äº«é€£çµï¼š
            <div id="qrcode-container" style="margin-top: 10px; background: white; padding: 10px; display: inline-block; border-radius: 12px;"></div>
        </div>
        <button class="btn-action" onclick="location.reload()" style="background:#333; color:white; font-size:16px; margin-top: 20px; max-width:none;">ğŸ”„ å†ç©ä¸€æ¬¡</button>
    </div>

    <canvas id="canvas-comp"></canvas>
    <canvas id="canvas-resize"></canvas>
    <canvas id="canvas"></canvas>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    const video = document.getElementById('webcam'), canvas = document.getElementById('canvas'), previewImg = document.getElementById('preview-img'), finalImg = document.getElementById('final-result'), cameraList = document.getElementById('camera-list'), errorMsg = document.getElementById('error-msg');
    const canvasComp = document.getElementById('canvas-comp');
    const canvasResize = document.getElementById('canvas-resize'); // V19: ç¸®åœ–ç”¨
    let currentGender = 'girl'; 
    let isUploadMode = false; 

    // V19 ä¿®æ­£: ç›¸æ©Ÿå•Ÿå‹•é‚è¼¯ (å¯¬é¬†æ¨¡å¼)
    async function firstStartCamera() {
        errorMsg.innerText = "";
        try {
            // 1. å…ˆè©¦è‘—ç›´æ¥é–‹ï¼Œä¸æŒ‘
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            
            // 2. æˆåŠŸé–‹å•Ÿå¾Œï¼Œåˆ—å‡ºæ¸…å–®
            await listCameras();
            stream.getTracks().forEach(track => track.stop()); // é—œé–‰æ¸¬è©¦æµ

            setMode(false);
            document.getElementById('step-permission').style.display = 'none';
            document.getElementById('step-selection').style.display = 'block';
        } catch (err) {
            console.error(err);
            errorMsg.innerText = "å•Ÿå‹•å¤±æ•—ï¼š" + err.message + "\nè«‹ç¢ºèªç€è¦½å™¨æ¬Šé™ã€‚";
        }
    }

    async function listCameras() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        cameraList.innerHTML = '';
        videoDevices.forEach((device, index) => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            let label = device.label || `ç›¸æ©Ÿ ${index + 1}`;
            if (label.toLowerCase().includes('back') || label.includes('å¾Œ')) label = "ğŸ“¸ å¾Œç½®é¡é ­";
            else if (label.toLowerCase().includes('front') || label.includes('å‰')) label = "ğŸ‘¤ å‰ç½®è‡ªæ‹";
            option.text = label;
            cameraList.appendChild(option);
        });
    }

    // V19 ä¿®æ­£: å¯¬é¬†çš„åˆ‡æ›é‚è¼¯
    async function startSpecificCamera() {
        const deviceId = cameraList.value;
        try {
            // å˜—è©¦é–‹å•ŸæŒ‡å®šé¡é ­
            const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } });
            video.srcObject = stream;
            document.getElementById('start-overlay').style.display = 'none';
            switchStage('stage-1');
        } catch (err) {
            // å¤±æ•—å°±é–‹é è¨­
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                document.getElementById('start-overlay').style.display = 'none';
                switchStage('stage-1');
            } catch (fatalErr) { alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹æ›å€‹ç€è¦½å™¨è©¦è©¦ã€‚"); }
        }
    }

    const optionsData = {
        girl: {
            clothes: [{val:"", txt:"(é è¨­)"}, {val:"wearing white hanfu", txt:"æ¼¢æœ/å¤è£"}, {val:"wearing princess dress", txt:"å¤¢å¹»å…¬ä¸»è£™"}, {val:"wearing qipao dress", txt:"æ——è¢"}, {val:"wearing school uniform", txt:"æ°´æ‰‹æœ/åˆ¶æœ"}, {val:"wearing business suit", txt:"è¥¿è£/å¥—è£"}, {val:"wearing casual t-shirt", txt:"ä¼‘é–’ Tæ¤"}, {val:"wearing cyberpunk armor", txt:"ç§‘æŠ€æˆ°ç”²"}, {val:"wearing witch robe", txt:"å¥³å·«è¢"}, {val:"wearing yoga outfit", txt:"ç‘œçˆæœ"}],
            hair: [{val:"", txt:"(é è¨­)"}, {val:"long curly hair", txt:"é•·æ²é«®"}, {val:"short bob hair", txt:"ä¿éº—çŸ­é«®"}, {val:"ponytail", txt:"é¦¬å°¾"}, {val:"straight long hair", txt:"é»‘é•·ç›´"}, {val:"twin tails", txt:"é›™é¦¬å°¾"}, {val:"braided hair", txt:"éº»èŠ±è¾®"}, {val:"hair bun", txt:"åŒ…åŒ…é ­"}, {val:"hime cut", txt:"å…¬ä¸»åˆ‡"}],
            headwear: [{val:"", txt:"(ç„¡)"}, {val:"wearing glasses", txt:"çœ¼é¡"}, {val:"wearing a flower hairpin", txt:"èŠ±æœµé«®ç°ª"}, {val:"wearing a crown", txt:"çš‡å† "}, {val:"wearing cat ears", txt:"è²“è€³"}, {val:"wearing a beret", txt:"ç•«å®¶å¸½"}, {val:"wearing a veil", txt:"é ­ç´—"}, {val:"wearing headphones", txt:"è€³æ©Ÿ"}, {val:"wearing a halo", txt:"å¤©ä½¿å…‰ç’°"}],
            held: [{val:"", txt:"(ç„¡)"}, {val:"holding a book", txt:"æ‹¿è‘—æ›¸"}, {val:"holding a lotus flower", txt:"æ‹¿è‘—è“®èŠ±"}, {val:"holding a magic wand", txt:"é­”æ³•æ£’"}, {val:"holding bubble tea", txt:"çç å¥¶èŒ¶"}, {val:"holding a camera", txt:"æ‹¿è‘—ç›¸æ©Ÿ"}, {val:"holding a fan", txt:"æ‹¿è‘—æ‰‡å­"}, {val:"holding a guitar", txt:"æŠ±è‘—å‰ä»–"}, {val:"holding a bouquet", txt:"æ§è‘—èŠ±æŸ"}]
        },
        boy: {
            clothes: [{val:"", txt:"(é è¨­)"}, {val:"wearing white hanfu", txt:"æ¼¢æœ/å¤è£"}, {val:"wearing business suit", txt:"è¥¿è£/æ­£è£"}, {val:"wearing doctor coat", txt:"é†«å¸«è¢"}, {val:"wearing leather jacket", txt:"å¸¥æ°£çš®è¡£"}, {val:"wearing basketball jersey", txt:"ç±ƒçƒè¡£"}, {val:"wearing casual hoodie", txt:"é€£å¸½è¡«"}, {val:"wearing cyberpunk armor", txt:"ç§‘æŠ€æˆ°ç”²"}, {val:"wearing tactical vest", txt:"æˆ°è¡“èƒŒå¿ƒ"}, {val:"wearing tuxedo", txt:"ç‡•å°¾æœ"}],
            hair: [{val:"", txt:"(é è¨­)"}, {val:"short hair", txt:"ä¿è½çŸ­é«®"}, {val:"middle part hair", txt:"éŸ“ç³»ä¸­åˆ†"}, {val:"slicked back hair", txt:"æ²¹é ­"}, {val:"buzz cut", txt:"å¹³é ­/å…‰é ­"}, {val:"spikey hair", txt:"åˆºèŸé ­"}, {val:"long hair", txt:"è—è¡“é•·é«®"}, {val:"dreadlocks", txt:"é›·é¬¼é«’è¾®"}, {val:"undercut", txt:"å…©å´æ¨é«˜"}],
            headwear: [{val:"", txt:"(ç„¡)"}, {val:"wearing glasses", txt:"çœ¼é¡"}, {val:"wearing a baseball cap", txt:"æ£’çƒå¸½"}, {val:"wearing a fedora", txt:"ç´³å£«å¸½"}, {val:"wearing a bandana", txt:"é ­å·¾"}, {val:"wearing headphones", txt:"è€³æ©Ÿ"}, {val:"wearing vr goggles", txt:"VRçœ¼é¡"}, {val:"wearing a halo", txt:"å¤©ä½¿å…‰ç’°"}, {val:"wearing a crown", txt:"åœ‹ç‹çš‡å† "}],
            held: [{val:"", txt:"(ç„¡)"}, {val:"holding a book", txt:"æ‹¿è‘—æ›¸"}, {val:"holding a sword", txt:"æ‹¿è‘—åŠ"}, {val:"holding a guitar", txt:"æŠ±è‘—å‰ä»–"}, {val:"holding a camera", txt:"æ‹¿è‘—ç›¸æ©Ÿ"}, {val:"holding a basketball", txt:"æ‹¿è‘—ç±ƒçƒ"}, {val:"holding a coffee cup", txt:"æ‹¿è‘—å’–å•¡"}, {val:"holding a laptop", txt:"æ‹¿è‘—ç­†é›»"}, {val:"holding a microphone", txt:"æ‹¿è‘—éº¥å…‹é¢¨"}]
        }
    };

    function updateOptions(gender) {
        const data = optionsData[gender];
        const populate = (id, items) => {
            const select = document.getElementById(id); select.innerHTML = "";
            items.forEach(item => { const opt = document.createElement("option"); opt.value = item.val; opt.innerText = item.txt; select.appendChild(opt); });
        };
        populate('opt-clothes', data.clothes); populate('opt-hair', data.hair); populate('opt-headwear', data.headwear); populate('opt-held', data.held);
    }
    function switchGender(g) {
        currentGender = g;
        document.getElementById('btn-boy').classList.toggle('selected', g==='boy');
        document.getElementById('btn-girl').classList.toggle('selected', g==='girl');
        updateOptions(g);
    }
    window.onload = () => { updateOptions('girl'); };

    function setMode(upload) {
        isUploadMode = upload;
        const stage2 = document.getElementById('stage-2');
        const uploadBtn = document.getElementById('btn-upload-finish');
        
        if (isUploadMode) {
            stage2.classList.add('upload-mode');
            uploadBtn.style.display = 'flex';
            previewImg.classList.remove('mirror');
        } else {
            stage2.classList.remove('upload-mode');
            uploadBtn.style.display = 'none';
            previewImg.classList.add('mirror');
        }
    }

    function triggerUpload() { document.getElementById('file-input').click(); }

    // V19 ä¿®æ­£: ä¸Šå‚³åœ–ç‰‡è‡ªå‹•ç¸®æ”¾ (è§£æ±ºåœ–ç‰‡éå¤§å•é¡Œ)
    document.getElementById('file-input').addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // ç¸®æ”¾é‚è¼¯ï¼šæœ€å¤§é‚Šé•· 1024
                    const MAX_SIZE = 1024;
                    let w = img.width;
                    let h = img.height;
                    if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } }
                    else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } }
                    
                    canvasResize.width = w;
                    canvasResize.height = h;
                    const ctx = canvasResize.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    
                    previewImg.src = canvasResize.toDataURL('image/jpeg', 0.9);
                    setMode(true);
                    document.getElementById('start-overlay').style.display = 'none';
                    switchStage('stage-2');
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    function finishUploadMode() { composeFinalImage(previewImg.src, "ç…§ç‰‡è£è£±ä¸­..."); }

    function capturePhoto() {
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d'); ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        previewImg.src = canvas.toDataURL('image/png'); 
        setMode(false); 
        switchStage('stage-2');
    }

    function composeFinalImage(sourceImageUrl, loadingMsg) {
        switchStage('stage-3'); 
        document.getElementById('loading-text').innerText = loadingMsg || "âš¡ è™•ç†ä¸­...";
        document.getElementById('prompt-debug').innerText = ""; 
        simulateProgress();

        const rawText = document.getElementById('text-main').value;
        const textStyle = document.getElementById('text-style').value;
        const signature = document.getElementById('text-signature').value;
        const position = document.getElementById('text-position').value;
        const frameStyle = document.getElementById('frame-style').value;

        const baseImg = new Image();
        baseImg.crossOrigin = "anonymous"; 
        baseImg.onload = () => {
            let frameThickness = 0;
            let matThickness = 0;
            if (frameStyle !== 'none') {
                frameThickness = Math.floor(baseImg.width * 0.05);
                if (frameStyle === 'museum_mat') matThickness = Math.floor(baseImg.width * 0.08);
            }
            
            const totalBorder = frameThickness + matThickness;
            canvasComp.width = baseImg.width + (totalBorder * 2);
            canvasComp.height = baseImg.height + (totalBorder * 2);
            const ctx = canvasComp.getContext('2d');
            const cw = canvasComp.width;
            const ch = canvasComp.height;

            if (frameStyle !== 'none') {
                applyFrameDrawing(ctx, frameStyle, cw, ch, frameThickness, matThickness);
            }

            const contentX = totalBorder;
            const contentY = totalBorder;
            const contentW = baseImg.width;
            const contentH = baseImg.height;

            ctx.drawImage(baseImg, contentX, contentY);

            ctx.save();
            ctx.beginPath();
            ctx.rect(contentX, contentY, contentW, contentH);
            ctx.clip();

            if (rawText && textStyle !== 'none') {
                const lines = rawText.split('\n');
                applyTextStyle(ctx, textStyle, contentW);
                ctx.textAlign = 'center';
                const fontSize = Math.floor(contentW / 15);
                const lineHeight = fontSize * 1.3;
                let startY;
                if (position === 'top') startY = contentY + 80;
                else if (position === 'center') startY = contentY + (contentH / 2) - ((lines.length * lineHeight) / 2);
                else startY = contentY + contentH - 150 - (lines.length * lineHeight);

                lines.forEach((line, i) => {
                    let y = startY + (i * lineHeight);
                    ctx.fillText(line, contentX + contentW / 2, y);
                    if (['comic', 'neon', 'stone'].includes(textStyle)) { ctx.strokeText(line, contentX + contentW / 2, y); }
                });
            }
            if (signature) {
                drawSignature(ctx, signature, contentX + contentW, contentY + contentH);
            }
            ctx.restore();

            if (frameStyle !== 'none' && frameStyle !== 'neon_cyber') {
                 drawInnerShadow(ctx, contentX, contentY, contentW, contentH);
            }

            finalImg.src = canvasComp.toDataURL('image/png');
            document.getElementById("qrcode-container").innerHTML = ""; 
            new QRCode(document.getElementById("qrcode-container"), { text: window.location.href, width: 120, height: 120 }); 
            switchStage('stage-4');
        };
        baseImg.onerror = () => { alert("åœ–ç‰‡è¼‰å…¥å¤±æ•—"); location.reload(); };
        baseImg.src = sourceImageUrl;
    }

    function applyFrameDrawing(ctx, style, w, h, ft, mt) {
        const total = ft + mt;
        ctx.fillStyle = (style === 'museum_mat') ? '#fcfcfc' : '#1a1a1a';
        ctx.fillRect(0, 0, w, h);
        if (mt > 0) {
            ctx.fillStyle = '#f0f0f0'; ctx.fillRect(ft, ft, w - ft*2, h - ft*2);
            ctx.strokeStyle = '#ddd'; ctx.lineWidth = 2; ctx.strokeRect(ft, ft, w - ft*2, h - ft*2);
        }
        if (ft > 0) {
            let grad = ctx.createLinearGradient(0, 0, w, h);
            switch(style) {
                case 'gold_classic': grad.addColorStop(0, '#b88a00'); grad.addColorStop(0.5, '#ffd700'); grad.addColorStop(1, '#b88a00'); break;
                case 'silver_antique': grad.addColorStop(0, '#555'); grad.addColorStop(0.5, '#aaa'); grad.addColorStop(1, '#555'); break;
                case 'wood_walnut': grad = ctx.createLinearGradient(0, 0, ft, 0); grad.addColorStop(0, '#3d2314'); grad.addColorStop(1, '#5c3a21'); break;
                case 'wood_oak': grad = ctx.createLinearGradient(0, 0, ft, 0); grad.addColorStop(0, '#c4a484'); grad.addColorStop(1, '#e3cdb5'); break;
                case 'gallery_black': case 'museum_mat': grad = '#222'; break;
                 case 'ornate_vintage': grad.addColorStop(0, '#4a3c2a'); grad.addColorStop(0.3, '#8c7355'); grad.addColorStop(0.7, '#4a3c2a'); grad.addColorStop(1, '#2b2218'); break;
                case 'modern_metal': grad.addColorStop(0, '#666'); grad.addColorStop(0.5, '#e6e6e6'); grad.addColorStop(1, '#666'); break;
                 case 'rustic': grad = ctx.createPattern(createWoodPattern(ft), 'repeat'); break;
                case 'neon_cyber': grad = '#000'; break;
            }
            ctx.beginPath(); ctx.rect(0, 0, w, h); ctx.rect(total, total, w - total*2, h - total*2); ctx.fillStyle = grad; ctx.fill('evenodd');
            if (style !== 'gallery_black' && style !== 'neon_cyber' && style !== 'rustic') {
                let gradLight = ctx.createLinearGradient(0,0,w,h); gradLight.addColorStop(0, 'rgba(255,255,255,0.4)'); gradLight.addColorStop(1, 'transparent');
                ctx.strokeStyle = gradLight; ctx.lineWidth = 4; ctx.strokeRect(0,0,w,h);
                let gradDark = ctx.createLinearGradient(0,0,w,h); gradDark.addColorStop(0, 'transparent'); gradDark.addColorStop(1, 'rgba(0,0,0,0.5)');
                ctx.strokeStyle = gradDark; ctx.lineWidth = 4; ctx.strokeRect(total, total, w - total*2, h - total*2);
            }
            if (style === 'neon_cyber') {
                ctx.shadowColor = '#00eaff'; ctx.shadowBlur = 30; ctx.strokeStyle = '#ff00de'; ctx.lineWidth = 6;
                ctx.strokeRect(total - 3, total - 3, w - total*2 + 6, h - total*2 + 6); ctx.shadowBlur = 0;
            }
        }
    }
    function drawInnerShadow(ctx, x, y, w, h) {
        ctx.shadowColor = "rgba(0,0,0,0.6)"; ctx.shadowBlur = 20; ctx.shadowOffsetX = 0; ctx.shadowOffsetY = 0;
        ctx.strokeStyle = "rgba(0,0,0,0.1)"; ctx.lineWidth = 1; ctx.strokeRect(x, y, w, h); ctx.shadowBlur = 0;
    }
    function createWoodPattern(size) {
        const pCanvas = document.createElement('canvas'); pCanvas.width = size; pCanvas.height = size; const pCtx = pCanvas.getContext('2d');
        pCtx.fillStyle = '#5c4033'; pCtx.fillRect(0,0,size,size);
        for(let i=0; i<10; i++) { pCtx.strokeStyle = 'rgba(0,0,0,0.2)'; pCtx.lineWidth = Math.random()*2+1; pCtx.beginPath(); pCtx.moveTo(0, Math.random()*size); pCtx.lineTo(size, Math.random()*size + Math.random()*10-5); pCtx.stroke(); }
        return pCanvas;
    }

    function applyTextStyle(ctx, style, w) {
        const fontSize = Math.floor(w / 15); ctx.font = `bold ${fontSize}px "Microsoft JhengHei", sans-serif`; ctx.lineWidth = fontSize / 10; ctx.shadowBlur = 0; ctx.shadowColor = 'transparent';
        switch(style) {
            case 'calligraphy': ctx.fillStyle = 'white'; ctx.font = `bold ${fontSize*1.2}px "Kaiti SC", STKaiti, serif`; ctx.shadowColor="black"; ctx.shadowBlur=10; break;
            case 'neon': ctx.fillStyle = '#00eaff'; ctx.strokeStyle = '#ff00de'; ctx.shadowColor = '#00eaff'; ctx.shadowBlur = 20; ctx.lineWidth = 5; break;
            case 'comic': ctx.fillStyle = '#ffd700'; ctx.strokeStyle = 'black'; ctx.lineWidth = 8; ctx.font = `900 ${fontSize*1.1}px "Arial Black", sans-serif`; break;
            case 'cute': ctx.fillStyle = '#ff99cc'; ctx.font = `bold ${fontSize}px "Comic Sans MS", cursive`; ctx.shadowColor="white"; ctx.shadowBlur=5; break;
            case 'elegant': ctx.fillStyle = '#d4af37'; ctx.font = `italic bold ${fontSize}px serif`; ctx.shadowColor="#333"; ctx.shadowBlur=5; break;
            case 'typewriter': ctx.fillStyle = '#00ff00'; ctx.font = `${fontSize}px monospace`; ctx.shadowColor="black"; ctx.shadowBlur=2; break;
            case 'graffiti': ctx.fillStyle = 'white'; ctx.strokeStyle = '#ff3300'; ctx.lineWidth = 5; ctx.font = `900 ${fontSize*1.2}px sans-serif`; break;
            case 'headline': ctx.fillStyle = 'white'; ctx.strokeStyle = 'black'; ctx.lineWidth = 4; ctx.font = `900 ${fontSize*1.3}px impact, sans-serif`; break;
            case 'stone': ctx.fillStyle = '#888888'; ctx.strokeStyle = '#333333'; ctx.lineWidth = 3; ctx.shadowColor="black"; ctx.shadowBlur=2; ctx.shadowOffsetX=2; ctx.shadowOffsetY=2; break;
            case 'ink': ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.font = `bold ${fontSize*1.1}px "Kaiti SC", STKaiti, serif`; ctx.shadowColor="rgba(255,255,255,0.5)"; ctx.shadowBlur=5; break;
        }
    }
    function drawSignature(ctx, name, rightX, bottomY) {
        const fontSize = Math.floor((rightX*0.9) / 25); ctx.font = `bold ${fontSize}px "Kaiti SC", STKaiti, serif`; ctx.fillStyle = '#cc0000'; ctx.textAlign = 'right'; ctx.shadowBlur = 0; ctx.shadowOffsetX=0; ctx.shadowOffsetY=0; ctx.fillText("â€” " + name + " å°", rightX - 30, bottomY - 30);
    }

    function getDetails() {
        const ids = ['opt-clothes', 'opt-hair', 'opt-headwear', 'opt-held', 'opt-location', 'opt-weather'];
        let details = [];
        ids.forEach(id => { const val = document.getElementById(id).value; if(val) details.push(val); });
        return details.join(", ");
    }
    
    function generateAI(styleKey) {
        if (isUploadMode) return;
        composeFinalImage(null, "âš¡ AI ç¹ªåœ–èˆ‡è£è£±ä¸­..."); 
        document.getElementById('prompt-debug').innerText = "AI æŒ‡ä»¤é‹ç®—ä¸­...";

        let genderBase = currentGender === 'boy' ? "handsome man, male" : "beautiful woman, female";
        let detailPrompt = getDetails(); 
        let fullPrompt = "";
        if(styleKey === 'pixar') fullPrompt = `cute 3d pixar style ${genderBase}, ${detailPrompt}, studio lighting, big eyes, 8k`;
        else if(styleKey === 'ghibli') fullPrompt = `studio ghibli anime portrait of ${genderBase}, ${detailPrompt}, hayao miyazaki style, watercolor background`;
        else if(styleKey === 'cyberpunk') fullPrompt = `cyberpunk portrait of ${genderBase}, ${detailPrompt}, neon lights, mechanical parts, futuristic city`;
        else if(styleKey === 'oil') fullPrompt = `van gogh oil painting portrait of ${genderBase}, ${detailPrompt}, thick brushstrokes, artistic, starry night`;
        else if(styleKey === 'comic') fullPrompt = `american comic superhero ${genderBase}, ${detailPrompt}, bold lines, halftone dots, marvel style`;
        else if(styleKey === 'ink') fullPrompt = `chinese ink wash painting portrait of ${genderBase}, ${detailPrompt}, black and white, sumi-e, artistic, red stamp`;
        else if(styleKey === 'real') fullPrompt = `(masterpiece), best quality, realistic photo of a ${genderBase}, ${detailPrompt}, highly detailed face, dslr, 8k, raw photo, soft lighting, looking at camera`;
        else if(styleKey === 'taoist') fullPrompt = `(masterpiece), traditional chinese ancient style portrait of ${genderBase}, ${detailPrompt}, righteous aura, ethereal atmosphere, soft lighting, hd, 8k`;
        
        const aiUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(fullPrompt)}?width=1024&height=1024&seed=${Math.floor(Math.random()*9999)}&nologo=true`;
        
        setTimeout(() => { composeFinalImage(aiUrl, "âš¡ AI ç¹ªåœ–èˆ‡è£è£±ä¸­..."); }, 100);
    }
    
    function simulateProgress() { const bar = document.getElementById('progress-bar'); let w = 0; const int = setInterval(() => { if(w>=90) clearInterval(int); w+=10; bar.style.width=w+'%'; }, 300); }
    function switchStage(id) { document.querySelectorAll('.stage').forEach(el => { el.style.display = 'none'; el.classList.remove('active'); }); const target = document.getElementById(id); target.style.display = 'flex'; setTimeout(()=>target.classList.add('active'), 10); }
</script>
</body>
</html>